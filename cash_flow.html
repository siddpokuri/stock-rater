<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Cash Flow Statement</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A very light gray background */
        }
        /* Custom styles for the toggle buttons */
        .toggle-button {
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .toggle-button.active {
            background-color: white;
            color: #2563eb; /* A nice blue color */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: none; /* Initially hidden */
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-center items-center">
            <div class="flex space-x-8 text-gray-600 font-semibold">
                <!-- Navigation items with dynamic hrefs set by JavaScript -->
                <a href="index.html" class="text-green-600 font-semibold hover:text-blue-600 transition-colors duration-300">Home</a>
                <a href="#" id="nav-general-info" class="hover:text-blue-600 transition-colors duration-300">General Info</a>
                <a href="#" id="nav-income-statement" class="hover:text-blue-600 transition-colors duration-300">Income Statement</a>
                <a href="#" id="nav-cash-flow" class="text-blue-700 font-bold transition-colors duration-300">Cash Flow</a>
                <a href="#" id="nav-balance-sheet" class="hover:text-blue-600 transition-colors duration-300">Balance Sheet</a>
                <a href="#" id="nav-ratings" class="hover:text-blue-600 transition-colors duration-300">Ratings</a>
                <a href="#" id="nav-earnings" class="hover:text-blue-600 transition-colors duration-300">Earnings</a>
                <a href="#" id="nav-insider-trades" class="hover:text-blue-600 transition-colors duration-300">Insider Trades</a>
                <a href="#" id="nav-analyst-targets" class="hover:text-blue-600 transition-colors duration-300">Analyst Targets</a>
                <a href="#" id="nav-recent-news" class="hover:text-blue-600 transition-colors duration-300">Recent News</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-8">
        <div class="flex flex-col items-center">
            <!-- Dynamic Title -->
            <h1 id="stock-title" class="text-3xl font-bold text-gray-800 mb-4">Stock - Cash Flow Statement</h1>

            <!-- Toggle buttons for Quarterly/Yearly views -->
            <div class="flex justify-center mb-4 bg-gray-200 rounded-full p-1">
                <button id="quarterly-btn" class="toggle-button py-2 px-6 rounded-full text-lg font-semibold active">Quarterly</button>
                <button id="yearly-btn" class="toggle-button py-2 px-6 rounded-full text-lg font-semibold">Yearly</button>
            </div>

            <!-- Loading Spinner & Error Message -->
            <div id="loading-area" class="flex flex-col items-center my-8">
                <div id="loading-spinner" class="loading-spinner"></div>
                <p id="error-message" class="text-red-500 mt-4 hidden text-center"></p>
            </div>

            <!-- Container for the financial data table -->
            <div id="statement-container" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-5xl">
                <!-- The table content will be injected here by JavaScript -->
            </div>
        </div>
    </main>

    <script>
        // Global variables to store the fetched data
        let currentBackendData = null;
        let activeView = 'Quarterly';

        // DOM elements
        const statementContainer = document.getElementById('statement-container');
        const quarterlyBtn = document.getElementById('quarterly-btn');
        const yearlyBtn = document.getElementById('yearly-btn');
        const stockTitle = document.getElementById('stock-title');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');

        /**
         * Renders the quarterly cash flow statement data.
         * @param {object} data The API response data.
         */
        function renderQuarterlyData(data) {
            const info = data["Quarterly Cash Flow Statement"];
            if (!info || info.length === 0) {
                statementContainer.innerHTML = '<p class="text-center text-gray-500">No quarterly cash flow data available.</p>';
                return;
            }

            // Extract dates from the first object, assuming they are consistent
            const dates = info.map(item => item.Date);

            // Metrics for the table, using a simplified list for clarity
            const metrics = [
                { name: "Net Income", key: "Net Income" },
                { name: "Net Cash from Operating Activities", key: "Net Cash Provided by Operating Activities" },
                { name: "Net Cash from Investing Activities", key: "Net Cash Provided by Investing Activities" },
                { name: "Net Cash from Financing Activities", key: "Net Cash Provided by Financing Activities" },
                { name: "Net Change in Cash", key: "Net Change in Cash" },
                { name: "Cash at Beginning of Period", key: "Cash at Beginning of Period" },
                { name: "Cash at End of Period", key: "Cash at End of Period" },
            ];

            let html = `
                <h2 class="text-xl font-bold text-gray-700 mb-6">Quarterly Cash Flow Statement</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-left">
                                <th class="py-3 px-4 font-semibold text-left border-b border-gray-200">Metric</th>
                                ${dates.map(date => `<th class="py-3 px-4 font-semibold text-right border-b border-gray-200">${date}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${metrics.map(metric => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-3 px-4 text-gray-800 font-medium text-left whitespace-nowrap">${metric.name}</td>
                                    ${info.map(item => `
                                        <td class="py-3 px-4 text-gray-600 text-right">
                                            ${item[metric.key] !== null && typeof item[metric.key] !== 'undefined' ? item[metric.key] : 'N/A'}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            statementContainer.innerHTML = html;
        }

        /**
         * Renders the yearly cash flow statement data.
         * @param {object} data The API response data.
         */
        function renderYearlyData(data) {
            const info = data["Yearly Cash Flow Statement"];
            if (!info || info.length === 0) {
                statementContainer.innerHTML = '<p class="text-center text-gray-500">No yearly cash flow data available.</p>';
                return;
            }

            // Extract dates from the first object, assuming they are consistent
            const dates = info.map(item => item.Date);

            // Metrics for the table, using a simplified list for clarity
            const metrics = [
                { name: "Net Income", key: "Net Income" },
                { name: "Net Cash from Operating Activities", key: "Net Cash Provided by Operating Activities" },
                { name: "Net Cash from Investing Activities", key: "Net Cash Provided by Investing Activities" },
                { name: "Net Cash from Financing Activities", key: "Net Cash Provided by Financing Activities" },
                { name: "Net Change in Cash", key: "Net Change in Cash" },
                { name: "Cash at Beginning of Period", key: "Cash at Beginning of Period" },
                { name: "Cash at End of Period", key: "Cash at End of Period" },
            ];

            let html = `
                <h2 class="text-xl font-bold text-gray-700 mb-6">Yearly Cash Flow Statement</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600">
                                <th class="py-3 px-4 font-semibold text-left border-b border-gray-200">Metric</th>
                                ${dates.map(date => `<th class="py-3 px-4 font-semibold text-right border-b border-gray-200">${date}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${metrics.map(metric => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-3 px-4 text-gray-800 font-medium text-left whitespace-nowrap">${metric.name}</td>
                                    ${info.map(item => `
                                        <td class="py-3 px-4 text-gray-600 text-right">
                                            ${item[metric.key] !== null && typeof item[metric.key] !== 'undefined' ? item[metric.key] : 'N/A'}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            statementContainer.innerHTML = html;
        }

        // Main rendering function to display data based on active view
        function renderData() {
            if (!currentBackendData) {
                return;
            }
            if (activeView === 'Quarterly') {
                renderQuarterlyData(currentBackendData);
            } else {
                renderYearlyData(currentBackendData);
            }
        }

        // API call to fetch data using a direct URL
        async function fetchStockData(ticker) {
            loadingSpinner.style.display = 'block';
            errorMessage.style.display = 'none';
            statementContainer.innerHTML = '';
            
            const apiUrl = `https://stock-backend-0128.onrender.com/tab2_5?stock=${ticker}`;
            
            try {
                // Fetch data with exponential backoff
                let response = null;
                let delay = 1000;
                let maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl);
                    if (response.ok) {
                        break;
                    }
                    if (response.status === 429) {
                        console.warn(`API call failed with status 429. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`API call failed with status ${response.status}`);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('Max retries reached, failed to fetch data.');
                }
                
                const data = await response.json();

                // Update the global data and render the view
                currentBackendData = data;
                stockTitle.textContent = `${ticker.toUpperCase()} - Cash Flow Statement`;
                renderData();
                
            } catch (error) {
                console.error('Failed to fetch stock data:', error);
                errorMessage.textContent = `Error: Could not retrieve data for ticker "${ticker}". Please try another ticker from the main page.`;
                errorMessage.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none'; // Hide the spinner
            }
        }

        // Add event listeners to the toggle buttons to switch views
        quarterlyBtn.addEventListener('click', () => {
            yearlyBtn.classList.remove('active');
            quarterlyBtn.classList.add('active');
            activeView = 'Quarterly';
            renderData();
        });

        yearlyBtn.addEventListener('click', () => {
            quarterlyBtn.classList.remove('active');
            yearlyBtn.classList.add('active');
            activeView = 'Yearly';
            renderData();
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const stockTicker = urlParams.get('stock');

            // Set the navigation bar links
            const navLinks = [
                { id: 'nav-general-info', file: 'general_info.html' },
                { id: 'nav-income-statement', file: 'income_statement.html' },
                { id: 'nav-cash-flow', file: 'cash_flow.html' },
                { id: 'nav-balance-sheet', file: 'balance_sheet.html' },
                { id: 'nav-ratings', file: 'ratings.html' },
                { id: 'nav-earnings', file: 'earnings.html' },
                { id: 'nav-insider-trades', file: 'insider_trades.html' },
                { id: 'nav-analyst-targets', file: 'analyst_targets.html' },
                { id: 'nav-recent-news', file: 'recent_news.html' },
            ];

            if (stockTicker) {
                fetchStockData(stockTicker);
                navLinks.forEach(link => {
                    const navElement = document.getElementById(link.id);
                    if (navElement) {
                        navElement.href = `${link.file}?stock=${stockTicker}`;
                    }
                });
            } else {
                stockTitle.textContent = 'No Stock Selected';
                statementContainer.innerHTML = '';
                errorMessage.textContent = 'Please return to the main page and select a stock to view its cash flow statement.';
                errorMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>
