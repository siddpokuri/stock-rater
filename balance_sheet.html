<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Balance Sheet</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A very light gray background */
        }
        /* Custom styles for the toggle buttons */
        .toggle-button {
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }
        .toggle-button.active {
            background-color: white;
            color: #2563eb; /* A nice blue color */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: none; /* Initially hidden */
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-center items-center">
            <div class="flex space-x-8 text-gray-600 font-semibold">
                <!-- Home button added to match income_statement.html -->
                <a href="index.html" class="text-green-600 font-semibold hover:text-blue-600 transition-colors duration-300">Home</a>
                <!-- Navigation items, with dynamic hrefs set by JavaScript -->
                <a href="#" id="nav-general-info" class="hover:text-blue-600 transition-colors duration-300">General Info</a>
                <a href="#" id="nav-income-statement" class="hover:text-blue-600 transition-colors duration-300">Income Statement</a>
                <a href="#" id="nav-cash-flow" class="hover:text-blue-600 transition-colors duration-300">Cash Flow</a>
                <a href="#" id="nav-balance-sheet" class="text-blue-700 font-bold transition-colors duration-300">Balance Sheet</a>
                <!-- Premium Links - HREFs will be set by JS or blocked if not premium -->
                <a href="#" id="nav-ratings" class="hover:text-blue-600 transition-colors duration-300">Ratings</a>
                <a href="#" id="nav-earnings" class="hover:text-blue-600 transition-colors duration-300">Earnings</a>
                <a href="#" id="nav-insider-trades" class="hover:text-blue-600 transition-colors duration-300">Insider Trades</a>
                <a href="#" id="nav-analyst-targets" class="hover:text-blue-600 transition-colors duration-300">Analyst Targets</a>
                <!-- The "Recent News" button has been added to the end of the navigation bar as requested. -->
                <a href="#" id="nav-recent-news" class="hover:text-blue-600 transition-colors duration-300">Recent News</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-8">
        <div class="flex flex-col items-center">
            <!-- Dynamic Title -->
            <h1 id="stock-title" class="text-3xl font-bold text-gray-800 mb-4">Stock - Balance Sheet</h1>
            
            <!-- Toggle buttons for Quarterly/Yearly views -->
            <div class="flex justify-center mb-4 bg-gray-200 rounded-full p-1">
                <button id="toggleQuarterly" class="toggle-button py-2 px-6 rounded-full text-lg font-semibold active">Quarterly</button>
                <button id="toggleYearly" class="toggle-button py-2 px-6 rounded-full text-lg font-semibold">Yearly</button>
            </div>

            <!-- Loading Spinner & Error Message -->
            <div id="loading-area" class="flex flex-col items-center my-8">
                <div id="loading-spinner" class="loading-spinner"></div>
                <p id="error-message" class="text-red-500 mt-4 hidden text-center"></p>
                <!-- This is the new message box for premium access -->
                <p id="premium-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-4 hidden text-center"></p>
            </div>

            <!-- Container for the financial data table -->
            <div id="statement-container" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-5xl">
                <!-- The table content will be injected here by JavaScript -->
            </div>
        </div>
    </main>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js"; // Updated SDK version
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js"; // Updated SDK version
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js"; // Added Firestore

      const firebaseConfig = {
        apiKey: "AIzaSyBFBOe8Op4jPw4SR6Yla3hs-y4xzqDApoY",
        authDomain: "stocksight-75940.firebaseapp.com",
        projectId: "stocksight-75940",
        storageBucket: "stocksight-75940.firebasestorage.app",
        messagingSenderId: "223645254786",
        appId: "1:223645254786:web:14c980e559d9090f89e09b",
        measurementId: "G-8JGEEE9KD1"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app); // Initialize Firestore

      // Global variable to store user's premium status
      window.currentUserIsPremium = false;

      onAuthStateChanged(auth, async (user) => { // Made async to use await
        if (!user) {
          window.location.href = "auth.html"; // redirect if not logged in
        } else {
          // Fetch user's premium status from Firestore
          const userDocRef = doc(db, "users", user.uid);
          try {
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
              window.currentUserIsPremium = userDoc.data().isPremium || false; // Default to false if not set
            } else {
              console.warn("User document not found for UID:", user.uid);
              window.currentUserIsPremium = false;
            }
          } catch (e) {
            console.error("Error fetching user premium status:", e);
            window.currentUserIsPremium = false;
          }
          console.log("Current user premium status:", window.currentUserIsPremium);
        }
      });

      window.signOutUser = async function() {
        try {
          await signOut(auth);
          window.location.href = "auth.html"; // redirect after logout
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };
    </script>
    <script>
        // Global variables to store the fetched data and current view
        let balanceSheetData = null;
        let activeView = 'quarterly';
        const backendBaseUrl = 'https://stock-backend-0128.onrender.com';
        let stockSymbol = '';

        // DOM elements
        const statementContainer = document.getElementById('statement-container');
        const toggleQuarterlyBtn = document.getElementById('toggleQuarterly');
        const toggleYearlyBtn = document.getElementById('toggleYearly');
        const stockTitle = document.getElementById('stock-title');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const premiumMessage = document.getElementById('premium-message'); // New premium message element

        // Function to render the quarterly balance sheet data.
        function renderQuarterlyData(data) {
            const quarterlyInfo = data['Quarterly Balance Sheet Info'];
            
            if (!quarterlyInfo || !quarterlyInfo.Date || quarterlyInfo.Date.length === 0) {
                statementContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">No quarterly data available.</p>';
                return;
            }

            const metrics = [
                'Cash/Cash Equivalents', 'Short Term Investments', 'Total Current Assets', 'Total Assets',
                'Short Term Debt', 'Long Term Debt', 'Total Debt', 'Net Debt', 'Total Liabilities', "Total Stockholders' Equity"
            ];

            let html = `
                <h2 class="text-xl font-bold text-gray-700 mb-6">Quarterly Balance Sheet</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600">
                                <th class="py-3 px-4 font-semibold text-left">Metric</th>
                                ${quarterlyInfo.Date.map(date => `<th class="py-3 px-4 font-semibold text-right">${date}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${metrics.map(metric => `
                                <tr>
                                    <td class="py-3 px-4 text-gray-800 font-medium text-left">${metric}</td>
                                    ${quarterlyInfo[metric].map(value => `
                                        <td class="py-3 px-4 text-gray-600 text-right">
                                            ${value !== null && value !== undefined ? formatNumber(value) : 'N/A'}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            statementContainer.innerHTML = html;
        }

        // Function to render the yearly balance sheet data.
        function renderYearlyData(data) {
            const yearlyInfo = data['Yearly Balance Sheet Info'];

            if (!yearlyInfo || !yearlyInfo.Year || yearlyInfo.Year.length === 0) {
                statementContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">No yearly data available.</p>';
                return;
            }

            const years = yearlyInfo.Year;

            const metrics = [
                'Cash/Cash Equivalents', 'Short Term Investments', 'Total Current Assets', 'Total Assets',
                'Short Term Debt', 'Long Term Debt', 'Total Debt', 'Net Debt', 'Total Liabilities', "Total Stockholders' Equity"
            ];
            
            let html = `
                <h2 class="text-xl font-bold text-gray-700 mb-6">Yearly Balance Sheet</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600">
                                <th class="py-3 px-4 font-semibold text-left">Metric</th>
                                ${years.map(year => `<th class="py-3 px-4 font-semibold text-right">${year}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${metrics.map(metric => {
                                const values = yearlyInfo[metric] || [];
                                return `
                                    <tr>
                                        <td class="py-3 px-4 text-gray-800 font-medium text-left">${metric}</td>
                                        ${values.map(value => `
                                            <td class="py-3 px-4 text-gray-600 text-right">
                                                ${value !== null && value !== undefined ? formatNumber(value) : 'N/A'}
                                            </td>
                                        `).join('')}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            statementContainer.innerHTML = html;
        }

        // Main rendering function to display data based on active view
        function renderData() {
            if (!balanceSheetData) {
                return;
            }
            if (activeView === 'quarterly') {
                renderQuarterlyData(balanceSheetData);
            } else {
                renderYearlyData(balanceSheetData);
            }
        }

        // Helper function to format numbers. This function correctly handles negative values
        // as well as the 'N/A' case for null or undefined values.
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            // Handle values that are already formatted strings like '123.45M'
            if (typeof num === 'string' && num.match(/^[\d.]+[BMKT]?$/i)) {
                return num;
            }
            
            let value = Number(num);
            if (isNaN(value)) return 'N/A';

            const absValue = Math.abs(value);
            const sign = value < 0 ? '-' : '';

            if (absValue >= 1.0e+9) {
                return sign + (absValue / 1.0e+9).toFixed(2) + "B";
            }
            if (absValue >= 1.0e+6) {
                return sign + (absValue / 1.0e+6).toFixed(2) + "M";
            }
            if (absValue >= 1.0e+3) {
                return sign + (absValue / 1.0e+3).toFixed(2) + "K";
            }
            return sign + absValue.toFixed(2);
        }

        // API call to fetch data using a direct URL
        async function fetchBalanceSheet(ticker) {
            loadingSpinner.style.display = 'block';
            errorMessage.style.display = 'none';
            premiumMessage.classList.add('hidden'); // Hide premium message on new fetch
            statementContainer.innerHTML = '';
            
            const apiUrl = `${backendBaseUrl}/tab3?stock=${ticker}`;
            
            try {
                // Fetch data with exponential backoff
                let response = null;
                let delay = 1000;
                let maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl);
                    if (response.ok) {
                        break;
                    }
                    if (response.status === 429) {
                        console.warn(`API call failed with status 429. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`API call failed with status ${response.status}`);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('Max retries reached, failed to fetch data.');
                }
                
                const data = await response.json();

                // Update the global data and render the view
                balanceSheetData = data;
                stockTitle.textContent = `${ticker.toUpperCase()} - Balance Sheet`;
                renderData();
                
            } catch (error) {
                console.error('Failed to fetch stock data:', error);
                errorMessage.textContent = `Error: Could not retrieve data for ticker "${ticker}". Please try another ticker from the main page.`;
                errorMessage.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none'; // Hide the spinner
            }
        }
        
        // Add event listeners to the toggle buttons to switch views
        toggleQuarterlyBtn.addEventListener('click', () => {
            toggleYearlyBtn.classList.remove('active');
            toggleQuarterlyBtn.classList.add('active');
            activeView = 'quarterly';
            renderData();
        });

        toggleYearlyBtn.addEventListener('click', () => {
            toggleQuarterlyBtn.classList.remove('active');
            toggleYearlyBtn.classList.add('active');
            activeView = 'yearly';
            renderData();
        });

        // Function to show premium message
        function showPremiumMessage() {
            premiumMessage.innerHTML = 'Please get <a href="pricing.html" class="underline text-blue-500 hover:text-blue-700">Premium</a> to access this feature.';
            premiumMessage.classList.remove('hidden');

            // Hide the message after 5 seconds
            setTimeout(() => {
                premiumMessage.classList.add('hidden');
            }, 5000);
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            stockSymbol = urlParams.get('stock');

            // Set the navigation bar links
            const navLinks = [
                { id: 'nav-general-info', file: 'general_info.html' },
                { id: 'nav-income-statement', file: 'income_statement.html' },
                { id: 'nav-cash-flow', file: 'cash_flow.html' },
                { id: 'nav-balance-sheet', file: 'balance_sheet.html' },
                { id: 'nav-ratings', file: 'ratings.html', premium: true }, // Mark as premium
                { id: 'nav-earnings', file: 'earnings.html' },
                { id: 'nav-insider-trades', file: 'insider_trades.html', premium: true }, // Mark as premium
                { id: 'nav-analyst-targets', file: 'analyst_targets.html', premium: true }, // Mark as premium
                { id: 'nav-recent-news', file: 'recent_news.html' },
            ];

            if (stockSymbol) {
                fetchBalanceSheet(stockSymbol);
                navLinks.forEach(link => {
                    const navElement = document.getElementById(link.id);
                    if (navElement) {
                        if (link.premium) {
                            // For premium links, attach an event listener
                            navElement.href = '#'; // Set a dummy href for styling/accessibility
                            navElement.addEventListener('click', (event) => {
                                event.preventDefault(); // Prevent default navigation
                                // Use window.currentUserIsPremium from the Firebase script
                                if (window.currentUserIsPremium) {
                                    window.location.href = `${link.file}?stock=${stockSymbol}`;
                                } else {
                                    showPremiumMessage();
                                }
                            });
                        } else {
                            // For non-premium links, set href directly as before
                            navElement.href = `${link.file}?stock=${stockSymbol}`;
                        }
                    }
                });
            } else {
                stockTitle.textContent = 'No Stock Selected';
                statementContainer.innerHTML = '';
                errorMessage.textContent = 'Please return to the main page and select a stock to view its balance sheet.';
                errorMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>
