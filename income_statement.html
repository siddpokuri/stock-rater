<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Income Statement</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for creating the bar graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom font for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A very light gray background */
        }
        /* Custom styles for the toggle buttons */
        .toggle-button {
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .toggle-button.active {
            background-color: white;
            color: #2563eb; /* A nice blue color */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: none; /* Initially hidden */
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-center items-center">
            <div class="flex space-x-8 text-gray-600 font-semibold">
                <!-- A "Home" button has been added here, with green text as requested. -->
                <a href="index.html" class="text-green-600 font-semibold hover:text-blue-600 transition-colors duration-300">Home</a>
                <!-- Navigation items, with dynamic hrefs set by JavaScript -->
                <a href="#" id="nav-general-info" class="hover:text-blue-600 transition-colors duration-300">General Info</a>
                <a href="#" id="nav-income-statement" class="text-blue-700 font-bold transition-colors duration-300">Income Statement</a>
                <a href="#" id="nav-balance-sheet" class="hover:text-blue-600 transition-colors duration-300">Balance Sheet</a>
                <a href="#" id="nav-ratings" class="hover:text-blue-600 transition-colors duration-300">Ratings</a>
                <a href="#" id="nav-earnings" class="hover:text-blue-600 transition-colors duration-300">Earnings</a>
                <a href="#" id="nav-insider-trades" class="hover:text-blue-600 transition-colors duration-300">Insider Trades</a>
                <a href="#" id="nav-analyst-targets" class="hover:text-blue-600 transition-colors duration-300">Analyst Targets</a>
                <!-- The "Recent News" button has been moved to the end as requested. -->
                <a href="#" id="nav-recent-news" class="hover:text-blue-600 transition-colors duration-300">Recent News</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-8">
        <div class="flex flex-col items-center">
            <!-- Dynamic Title -->
            <h1 id="stock-title" class="text-3xl font-bold text-gray-800 mb-4">Stock - Income Statement</h1>

            <!-- Toggle buttons for Quarterly/Yearly views -->
            <div class="flex justify-center mb-4 bg-gray-200 rounded-full p-1">
                <button id="quarterly-btn" class="toggle-button py-2 px-6 rounded-full text-lg font-semibold active">Quarterly</button>
                <button id="yearly-btn" class="toggle-button py-2 px-6 rounded-full text-lg font-semibold">Yearly</button>
            </div>

            <!-- Loading Spinner & Error Message -->
            <div id="loading-area" class="flex flex-col items-center my-8">
                <div id="loading-spinner" class="loading-spinner"></div>
                <p id="error-message" class="text-red-500 mt-4 hidden text-center"></p>
            </div>

            <!-- Container for the financial data table -->
            <div id="statement-container" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-5xl">
                <!-- The table content will be injected here by JavaScript -->
            </div>

            <!-- Container for the charts, now with a fixed height -->
            <div id="charts-container" class="w-full max-w-5xl flex flex-col md:flex-row justify-center gap-6 mt-8">
                <!-- Chart containers with a set height (h-80) to prevent them from being too tall -->
                <div class="w-full md:w-1/2 bg-white p-6 rounded-2xl shadow-xl h-80">
                    <h3 id="revenue-chart-title" class="text-lg font-bold text-gray-700 mb-4 text-center">Revenue</h3>
                    <canvas id="revenue-chart"></canvas>
                </div>
                <div class="w-full md:w-1/2 bg-white p-6 rounded-2xl shadow-xl h-80">
                    <h3 id="net-income-chart-title" class="text-lg font-bold text-gray-700 mb-4 text-center">Net Income</h3>
                    <canvas id="net-income-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables to store the fetched data and chart instances
        let currentBackendData = null;
        let activeView = 'Quarterly';
        let revenueChartInstance = null;
        let netIncomeChartInstance = null;

        // DOM elements
        const statementContainer = document.getElementById('statement-container');
        const quarterlyBtn = document.getElementById('quarterly-btn');
        const yearlyBtn = document.getElementById('yearly-btn');
        const stockTitle = document.getElementById('stock-title');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const revenueChartCanvas = document.getElementById('revenue-chart');
        const netIncomeChartCanvas = document.getElementById('net-income-chart');
        const chartsContainer = document.getElementById('charts-container');
        const revenueChartTitle = document.getElementById('revenue-chart-title');
        const netIncomeChartTitle = document.getElementById('net-income-chart-title');
        chartsContainer.style.display = 'none'; // Initially hide charts container

        /**
         * Clears any existing chart instances to prevent rendering issues.
         */
        function destroyExistingCharts() {
            if (revenueChartInstance) {
                revenueChartInstance.destroy();
                revenueChartInstance = null;
            }
            if (netIncomeChartInstance) {
                netIncomeChartInstance.destroy();
                netIncomeChartInstance = null;
            }
        }

        /**
         * Parses a financial string with suffixes (B, M, k) into a number.
         * @param {string|number} value The financial value to parse.
         * @returns {number|null} The parsed number or null if parsing fails.
         */
        function parseFinancialString(value) {
            if (value === null || typeof value === 'undefined') {
                return null;
            }
            if (typeof value === 'number') {
                return value;
            }
            const val = String(value).trim();
            const lastChar = val.slice(-1).toLowerCase();
            const number = parseFloat(val.slice(0, -1));

            if (isNaN(number) || !['b', 'm', 'k'].includes(lastChar)) {
                return parseFloat(val) || null;
            }

            switch (lastChar) {
                case 'b':
                    return number * 1e9;
                case 'm':
                    return number * 1e6;
                case 'k':
                    return number * 1e3;
                default:
                    return parseFloat(val) || null;
            }
        }

        /**
         * Scales an array of financial data for easier chart visualization.
         * @param {string[]} dataArray The array of financial strings (e.g., ["1.2B", "900M"]).
         * @returns {{scaledData: number[], unit: string}} An object with the scaled data and the unit string.
         */
        function scaleFinancialData(dataArray) {
            const parsedData = dataArray.map(parseFinancialString).filter(d => d !== null);
            if (parsedData.length === 0) {
                return { scaledData: [], unit: "" };
            }

            const maxVal = Math.max(...parsedData.map(Math.abs));
            let unit = "";
            let scaleFactor = 1;

            if (maxVal >= 1e9) {
                unit = "in billions";
                scaleFactor = 1e9;
            } else if (maxVal >= 1e6) {
                unit = "in millions";
                scaleFactor = 1e6;
            } else if (maxVal >= 1e3) {
                unit = "in thousands";
                scaleFactor = 1e3;
            }

            const scaledData = parsedData.map(val => val / scaleFactor);
            return { scaledData, unit };
        }

        /**
         * Creates a bar chart using Chart.js.
         * @param {HTMLCanvasElement} canvasElement The canvas element to render the chart on.
         * @param {string} title The title of the chart.
         * @param {string[]} labels The labels for the x-axis (e.g., dates).
         * @param {number[]} data The data values for the bars.
         * @returns {Chart} The new Chart.js instance.
         */
        function createChart(canvasElement, title, labels, data) {
            const chartData = {
                labels: labels,
                datasets: [{
                    label: title,
                    data: data,
                    backgroundColor: [
                        '#2563eb', // Blue
                        '#3b82f6',
                        '#60a5fa',
                        '#93c5fd'
                    ],
                    borderColor: '#1d4ed8',
                    borderWidth: 1
                }]
            };

            const chartConfig = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    // Simply return the scaled number
                                    return value.toFixed(1);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: title
                        }
                    }
                }
            };
            return new Chart(canvasElement, chartConfig);
        }

        /**
         * Renders the quarterly income statement data.
         * @param {object} data The API response data.
         */
        function renderQuarterlyData(data) {
            const info = data["Quarterly Income Statement Info"];
            
            // Metrics for the table, using original string values
            const metrics = [
                { name: "Revenue", data: info["Revenue"] },
                { name: "Gross Profit", data: info["Gross Profit"] },
                { name: "Ebitda", data: info["Ebitda"] },
                { name: "Operating Income", data: info["Operating Income"] },
                { name: "Net Income", data: info["Net Income"] },
            ];

            let html = `
                <h2 class="text-xl font-bold text-gray-700 mb-6">Quarterly Income Statement</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-left">
                                <th class="py-3 px-4 font-semibold text-left border-b border-gray-200">Metric</th>
                                ${info.dates.map(date => `<th class="py-3 px-4 font-semibold text-right border-b border-gray-200">${date}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${metrics.map(metric => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-3 px-4 text-gray-800 font-medium text-left whitespace-nowrap">${metric.name}</td>
                                    ${metric.data.map(value => `
                                        <td class="py-3 px-4 text-gray-600 text-right">
                                            ${value !== null && typeof value !== 'undefined' ? value : 'N/A'}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            statementContainer.innerHTML = html;

            // Prepare and render the charts with scaled numerical data
            destroyExistingCharts();
            chartsContainer.style.display = 'flex';
            const lastFourDates = info.dates.slice(-4);

            const { scaledData: scaledRevenue, unit: revenueUnit } = scaleFinancialData(info.Revenue.slice(-4));
            revenueChartTitle.textContent = `Revenue (${revenueUnit})`;
            revenueChartInstance = createChart(revenueChartCanvas, `Revenue (${revenueUnit})`, lastFourDates, scaledRevenue);

            const { scaledData: scaledNetIncome, unit: netIncomeUnit } = scaleFinancialData(info["Net Income"].slice(-4));
            netIncomeChartTitle.textContent = `Net Income (${netIncomeUnit})`;
            netIncomeChartInstance = createChart(netIncomeChartCanvas, `Net Income (${netIncomeUnit})`, lastFourDates, scaledNetIncome);
        }

        /**
         * Renders the yearly income statement data.
         * @param {object} data The API response data.
         */
        function renderYearlyData(data) {
            const info = data["Yearly Income Statement Info"];
            const ratios = data["Yearly Ratios"];
            
            // Get the headers from the API data
            const headers = info["Date"];
            
            // Metrics for the table, using original string values
            const metrics = [
                { name: "Revenue", data: info["Revenue"] },
                { name: "Gross Profit", data: info["Gross Profit"] },
                { name: "Ebitda", data: info["Ebitda"] },
                { name: "Operating Income", data: info["Operating Income"] },
                { name: "Net Income", data: info["Net Income"] },
                // These ratios are already in a displayable format
                { name: "Net Profit Margin (%)", data: ['N/A', ...ratios["Net Profit Margin (%)"]] },
                { name: "Price to Sales Ratio", data: ['N/A', ...ratios["Price to Sales Ratio"]] },
            ];

            let html = `
                <h2 class="text-xl font-bold text-gray-700 mb-6">Yearly Income Statement</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600">
                                <th class="py-3 px-4 font-semibold text-left border-b border-gray-200">Metric</th>
                                ${headers.map(date => `<th class="py-3 px-4 font-semibold text-right border-b border-gray-200">${date}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${metrics.map(metric => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-3 px-4 text-gray-800 font-medium text-left whitespace-nowrap">${metric.name}</td>
                                    ${metric.data.map(value => `
                                        <td class="py-3 px-4 text-gray-600 text-right">
                                            ${value !== null && typeof value !== 'undefined' ? value : 'N/A'}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            statementContainer.innerHTML = html;

            // Prepare and render the charts with scaled numerical data
            destroyExistingCharts();
            chartsContainer.style.display = 'flex';
            const lastFourDates = headers.slice(-4);
            
            const { scaledData: scaledRevenue, unit: revenueUnit } = scaleFinancialData(info.Revenue.slice(-4));
            revenueChartTitle.textContent = `Revenue (${revenueUnit})`;
            revenueChartInstance = createChart(revenueChartCanvas, `Revenue (${revenueUnit})`, lastFourDates, scaledRevenue);

            const { scaledData: scaledNetIncome, unit: netIncomeUnit } = scaleFinancialData(info["Net Income"].slice(-4));
            netIncomeChartTitle.textContent = `Net Income (${netIncomeUnit})`;
            netIncomeChartInstance = createChart(netIncomeChartCanvas, `Net Income (${netIncomeUnit})`, lastFourDates, scaledNetIncome);
        }

        // Main rendering function to display data based on active view
        function renderData() {
            if (!currentBackendData) {
                return;
            }
            if (activeView === 'Quarterly') {
                renderQuarterlyData(currentBackendData);
            } else {
                renderYearlyData(currentBackendData);
            }
        }

        // API call to fetch data using a direct URL
        async function fetchStockData(ticker) {
            loadingSpinner.style.display = 'block';
            errorMessage.style.display = 'none';
            statementContainer.innerHTML = '';
            chartsContainer.style.display = 'none'; // Hide charts while loading
            
            const apiUrl = `https://stock-backend-0128.onrender.com/tab2?stock=${ticker}`;
            
            try {
                // Fetch data with exponential backoff
                let response = null;
                let delay = 1000;
                let maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl);
                    if (response.ok) {
                        break;
                    }
                    if (response.status === 429) {
                        console.warn(`API call failed with status 429. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`API call failed with status ${response.status}`);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('Max retries reached, failed to fetch data.');
                }
                
                const data = await response.json();

                // Update the global data and render the view
                currentBackendData = data;
                stockTitle.textContent = `${ticker.toUpperCase()} - Income Statement`;
                renderData();
                
            } catch (error) {
                console.error('Failed to fetch stock data:', error);
                destroyExistingCharts(); // Clear charts on error
                errorMessage.textContent = `Error: Could not retrieve data for ticker "${ticker}". Please try another ticker from the main page.`;
                errorMessage.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none'; // Hide the spinner
            }
        }

        // Add event listeners to the toggle buttons to switch views
        quarterlyBtn.addEventListener('click', () => {
            yearlyBtn.classList.remove('active');
            quarterlyBtn.classList.add('active');
            activeView = 'Quarterly';
            renderData();
        });

        yearlyBtn.addEventListener('click', () => {
            quarterlyBtn.classList.remove('active');
            yearlyBtn.classList.add('active');
            activeView = 'Yearly';
            renderData();
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const stockTicker = urlParams.get('stock');

            // Set the navigation bar links
            const navLinks = [
                { id: 'nav-general-info', file: 'general_info.html' },
                { id: 'nav-income-statement', file: 'income_statement.html' },
                { id: 'nav-balance-sheet', file: 'balance_sheet.html' },
                { id: 'nav-ratings', file: 'ratings.html' },
                { id: 'nav-earnings', file: 'earnings.html' },
                { id: 'nav-insider-trades', file: 'insider_trades.html' },
                { id: 'nav-analyst-targets', file: 'analyst_targets.html' },
                { id: 'nav-recent-news', file: 'recent_news.html' },
            ];

            if (stockTicker) {
                fetchStockData(stockTicker);
                navLinks.forEach(link => {
                    const navElement = document.getElementById(link.id);
                    if (navElement) {
                        navElement.href = `${link.file}?stock=${stockTicker}`;
                    }
                });
            } else {
                stockTitle.textContent = 'No Stock Selected';
                statementContainer.innerHTML = '';
                errorMessage.textContent = 'Please return to the main page and select a stock to view its income statement.';
                errorMessage.style.display = 'block';
                destroyExistingCharts();
            }
        });
    </script>
</body>
</html>
