<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Info - Income Statement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .nav-button {
            @apply px-4 py-2 rounded-lg font-semibold transition duration-200 ease-in-out;
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .nav-button.active {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .toggle-button {
            @apply px-6 py-3 rounded-lg font-semibold text-lg transition duration-200 ease-in-out;
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
        }
        .toggle-button.active {
            @apply bg-green-600 text-white hover:bg-green-700;
        }
        .data-table th, .data-table td {
            @apply px-4 py-2 text-left;
        }
        .data-table th {
            @apply bg-gray-50 text-gray-600 uppercase text-sm;
        }
        .data-table tr:nth-child(even) {
            @apply bg-gray-50;
        }
        /* Ensure canvases are responsive within their containers */
        canvas {
            max-width: 100%;
            height: 100%; /* Let the parent div control height */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-md py-4 px-6 flex flex-wrap justify-center gap-4">
        <a href="#" id="navGeneral" class="nav-button">General Info</a>
        <a href="#" id="navIncome" class="nav-button active">Income Statement</a>
        <a href="#" id="navBalance" class="nav-button">Balance Sheet</a>
        <a href="#" id="navRatings" class="nav-button">Ratings</a>
        <a href="#" id="navEarnings" class="nav-button">Earnings</a>
        <a href="#" id="navInsider" class="nav-button">Insider Trades</a>
        <a href="#" id="navTargets" class="nav-button">Analyst Targets</a>
    </header>

    <main class="container mx-auto p-6">
        <h1 id="stockTitle" class="text-4xl font-bold text-gray-800 mb-8 text-center"></h1>
        
        <div id="loadingIndicator" class="text-center text-gray-600 text-lg mt-10">
            Fetching Income Statement Data...
        </div>

        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-10" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="errorText"></span>
        </div>

        <div id="incomeStatementContent" class="hidden">
            <div class="flex justify-center mb-6 space-x-4">
                <button id="toggleQuarterly" class="toggle-button active">Quarterly</button>
                <button id="toggleYearly" class="toggle-button">Yearly</button>
            </div>

            <!-- Quarterly Data Section -->
            <div id="quarterlyData" class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Quarterly Revenue Trend</h2>
                <canvas id="quarterlyRevenueChart"></canvas>

                <h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4 text-center">Quarterly Financials & Ratios</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg data-table">
                        <thead>
                            <tr id="quarterlyHeaderRow">
                                <th>Metric</th>
                                <!-- Quarterly dates will be inserted here -->
                            </tr>
                        </thead>
                        <tbody id="quarterlyTableBody">
                            <!-- Quarterly data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Yearly Data Section -->
            <div id="yearlyData" class="hidden bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Yearly Financials & Ratios (Latest Year)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg data-table">
                        <thead>
                            <tr id="yearlyHeaderRow">
                                <th>Metric</th>
                                <!-- Yearly date (e.g., 2025) will be inserted here -->
                            </tr>
                        </thead>
                        <tbody id="yearlyTableBody">
                            <!-- Latest year's data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let stockSymbol = '';
        let incomeStatementData = null; // Store fetched data globally
        let quarterlyRevenueChartInstance = null;
        const backendBaseUrl = 'https://stock-backend-0128.onrender.com';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            stockSymbol = urlParams.get('stock');

            if (!stockSymbol) {
                showError('No stock symbol provided in the URL.');
                return;
            }

            document.getElementById('stockTitle').textContent = `${stockSymbol} - Income Statement`;
            fetchIncomeStatement(stockSymbol);
            setupNavigationButtons();
            setupToggleButtons();
        });

        function setupNavigationButtons() {
            const navButtons = {
                'navGeneral': 'general_info.html',
                'navIncome': 'income_statement.html',
                'navBalance': 'balance_sheet.html',
                'navRatings': 'ratings.html',
                'navEarnings': 'earnings.html',
                'navInsider': 'insider_trades.html',
                'navTargets': 'analyst_targets.html'
            };

            for (const [id, page] of Object.entries(navButtons)) {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        window.location.href = `${page}?stock=${stockSymbol}`;
                    });
                }
            }
        }

        function setupToggleButtons() {
            document.getElementById('toggleQuarterly').addEventListener('click', () => showData('quarterly'));
            document.getElementById('toggleYearly').addEventListener('click', () => showData('yearly'));
        }

        async function fetchIncomeStatement(symbol) {
            showLoading(true);
            try {
                const response = await fetch(`${backendBaseUrl}/tab2?stock=${symbol}`);
                const data = await response.json();

                if (response.ok) {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        incomeStatementData = data; // Store the fetched data
                        showData('quarterly'); // Show quarterly data by default
                        showLoading(false);
                        document.getElementById('incomeStatementContent').classList.remove('hidden');
                    }
                } else {
                    showError(data.error || 'Failed to fetch income statement data from backend.');
                }
            } catch (error) {
                console.error('Error fetching income statement:', error);
                showError('A network error occurred while fetching income statement. Please check your internet connection or try again later.');
            }
        }

        function showData(period) {
            if (!incomeStatementData) return;

            const quarterlySection = document.getElementById('quarterlyData');
            const yearlySection = document.getElementById('yearlyData');
            const toggleQuarterlyBtn = document.getElementById('toggleQuarterly');
            const toggleYearlyBtn = document.getElementById('toggleYearly');

            if (period === 'quarterly') {
                quarterlySection.classList.remove('hidden');
                yearlySection.classList.add('hidden');
                toggleQuarterlyBtn.classList.add('active');
                toggleYearlyBtn.classList.remove('active');
                displayQuarterlyData(incomeStatementData);
            } else {
                yearlySection.classList.remove('hidden');
                quarterlySection.classList.add('hidden');
                toggleYearlyBtn.classList.add('active');
                toggleQuarterlyBtn.classList.remove('active');
                displayYearlyData(incomeStatementData);
            }
        }

        function displayQuarterlyData(data) {
            const quarterlyInfo = data['Quarterly Income Statement Info'];
            const quarterlyRatios = data['Quarterly Ratios'];

            if (!quarterlyInfo || !quarterlyInfo.dates || quarterlyInfo.dates.length === 0) {
                document.getElementById('quarterlyData').innerHTML = '<p class="text-center text-gray-500 mt-4">No quarterly data available.</p>';
                return;
            }

            const dates = quarterlyInfo.dates;
            const headerRow = document.getElementById('quarterlyHeaderRow');
            headerRow.innerHTML = '<th>Metric</th>' + dates.map(date => `<th>${date}</th>`).join('');

            const tableBody = document.getElementById('quarterlyTableBody');
            tableBody.innerHTML = ''; // Clear previous content

            const metrics = [
                'Revenue', 'Gross Profit', 'Operating Income', 'Ebitda', 'Net Income'
            ];
            const ratios = [
                'Net Profit Margin', 'Price to Sales Ratio'
            ];

            metrics.forEach(metric => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${metric}</td>` + dates.map((_, i) => `<td>${formatNumber(quarterlyInfo[metric]?.[i]) || 'N/A'}</td>`).join('');
                tableBody.appendChild(row);
            });

            ratios.forEach(ratio => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${ratio}</td>` + dates.map((_, i) => `<td>${formatPercentage(quarterlyRatios[ratio]?.[i]) || 'N/A'}</td>`).join('');
                tableBody.appendChild(row);
            });

            // Render Quarterly Revenue Chart
            renderRevenueChart(
                'quarterlyRevenueChart',
                dates,
                quarterlyInfo['Revenue'],
                `${stockSymbol} Quarterly Revenue`,
                quarterlyRevenueChartInstance
            );
        }

        function displayYearlyData(data) {
            const yearlyInfo = data['Yearly Income Statement Info'];
            const yearlyRatios = data['Yearly Ratios'];

            if (!yearlyInfo || !yearlyInfo.Revenue || yearlyInfo.Revenue.length === 0) {
                document.getElementById('yearlyData').innerHTML = '<p class="text-center text-gray-500 mt-4">No yearly data available.</p>';
                return;
            }

            const latestYearIndex = yearlyInfo.Revenue.length - 1;
            const currentYear = new Date().getFullYear();
            // Assuming the latest data point corresponds to the current year or the most recent available year
            const latestYear = currentYear - (yearlyInfo.Revenue.length - 1 - latestYearIndex); 

            const yearlyHeaderRow = document.getElementById('yearlyHeaderRow');
            yearlyHeaderRow.innerHTML = `<th>Metric</th><th>${latestYear}</th>`;

            const yearlyTableBody = document.getElementById('yearlyTableBody');
            yearlyTableBody.innerHTML = ''; // Clear previous content

            const metrics = [
                'Revenue', 'Gross Profit', 'Operating Income', 'Ebitda', 'Net Income'
            ];
            const ratios = [
                'Net Profit Margin', 'Price to Sales Ratio'
            ];

            metrics.forEach(metric => {
                const row = document.createElement('tr');
                const value = Array.isArray(yearlyInfo[metric]) ? yearlyInfo[metric][latestYearIndex] : yearlyInfo[metric];
                row.innerHTML = `<td>${metric}</td><td>${formatNumber(value) || 'N/A'}</td>`;
                yearlyTableBody.appendChild(row);
            });

            ratios.forEach(ratio => {
                const row = document.createElement('tr');
                const value = yearlyRatios[ratio];
                row.innerHTML = `<td>${ratio}</td><td>${formatPercentage(value) || 'N/A'}</td>`;
                yearlyTableBody.appendChild(row);
            });

            // No yearly revenue change chart or separate metrics box needed as per new request
        }

        function renderRevenueChart(canvasId, labels, data, title, chartInstance) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            // For quarterly, assign to quarterlyRevenueChartInstance
            if (canvasId === 'quarterlyRevenueChart') {
                quarterlyRevenueChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue bars
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#374151'
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#4b5563'
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#4b5563',
                                    callback: function(value) {
                                        return formatNumber(value);
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Helper function to format large numbers (e.g., 1234567890 -> 1.23B)
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            num = Number(num);
            if (isNaN(num)) return 'N/A';

            const absNum = Math.abs(num);
            if (absNum >= 1.0e+9) {
                return (num / 1.0e+9).toFixed(2) + "B";
            }
            if (absNum >= 1.0e+6) {
                return (num / 1.0e+6).toFixed(2) + "M";
            }
            if (absNum >= 1.0e+3) {
                return (num / 1.0e+3).toFixed(2) + "K";
            }
            return num.toFixed(2);
        }

        // Helper function to format percentages
        function formatPercentage(num) {
            if (num === null || num === undefined) return 'N/A';
            num = Number(num);
            if (isNaN(num)) return 'N/A';
            return (num * 100).toFixed(2) + '%';
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            document.getElementById('incomeStatementContent').classList.toggle('hidden', show);
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('incomeStatementContent').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('errorText').textContent = message;
        }
    </script>
</body>
</html>
