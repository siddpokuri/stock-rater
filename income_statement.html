<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Info - Income Statement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .nav-button {
            @apply px-4 py-2 rounded-lg font-semibold transition duration-200 ease-in-out;
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .nav-button.active {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .toggle-button {
            @apply px-6 py-3 rounded-lg font-semibold text-lg transition duration-200 ease-in-out;
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
        }
        .toggle-button.active {
            @apply bg-green-600 text-white hover:bg-green-700;
        }
        /* Adjusted table cell and header styling */
        .data-table th, .data-table td {
            @apply px-4 py-2; /* Keep padding */
        }
        .data-table th {
            @apply bg-gray-50 text-gray-600 uppercase text-sm text-center; /* Align headers center */
        }
        .data-table td {
            @apply text-center; /* Ensure data cells are centered */
        }
        .data-table {
            @apply border-none; /* Remove main table border */
        }
        .data-table thead {
            @apply border-b border-gray-300; /* Keep a bottom border for header row */
        }
        .data-table tbody {
            @apply divide-y divide-gray-200; /* Add horizontal dividers for rows */
        }
        .data-table tr:nth-child(even) {
            @apply bg-gray-50;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-md py-4 px-6 flex flex-wrap justify-center gap-4">
        <a href="#" id="navGeneral" class="nav-button">General Info</a>
        <a href="#" id="navIncome" class="nav-button active">Income Statement</a>
        <a href="#" id="navBalance" class="nav-button">Balance Sheet</a>
        <a href="#" id="navRatings" class="nav-button">Ratings</a>
        <a href="#" id="navEarnings" class="nav-button">Earnings</a>
        <a href="#" id="navInsider" class="nav-button">Insider Trades</a>
        <a href="#" id="navTargets" class="nav-button">Analyst Targets</a>
    </header>

    <main class="container mx-auto p-6">
        <h1 id="stockTitle" class="text-4xl font-bold text-gray-800 mb-8 text-center"></h1>
        
        <div id="loadingIndicator" class="text-center text-gray-600 text-lg mt-10">
            Fetching Income Statement Data...
        </div>

        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-10" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="errorText"></span>
        </div>

        <div id="incomeStatementContent" class="hidden">
            <div class="flex justify-center mb-6 space-x-4">
                <button id="toggleQuarterly" class="toggle-button active">Quarterly</button>
                <button id="toggleYearly" class="toggle-button">Yearly</button>
            </div>

            <!-- Quarterly Data Section -->
            <div id="quarterlyData" class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Quarterly Financials & Ratios</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg data-table">
                        <thead>
                            <tr id="quarterlyHeaderRow">
                                <th class="text-left">Metric</th> <!-- Keep Metric header left-aligned -->
                                <!-- Quarterly dates will be inserted here -->
                            </tr>
                        </thead>
                        <tbody id="quarterlyTableBody">
                            <!-- Quarterly data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Yearly Data Section -->
            <div id="yearlyData" class="hidden bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Yearly Financials & Ratios (Latest Year)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg data-table">
                        <thead>
                            <tr id="yearlyHeaderRow">
                                <th class="text-left">Metric</th> <!-- Keep Metric header left-aligned -->
                                <!-- Yearly date (e.g., 2025) will be inserted here -->
                            </tr>
                        </thead>
                        <tbody id="yearlyTableBody">
                            <!-- Latest year's data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        let stockSymbol = '';
        let incomeStatementData = null; // Store fetched data globally
        const backendBaseUrl = 'https://stock-backend-0128.onrender.com';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            stockSymbol = urlParams.get('stock');

            if (!stockSymbol) {
                showError('No stock symbol provided in the URL.');
                return;
            }

            document.getElementById('stockTitle').textContent = `${stockSymbol} - Income Statement`;
            fetchIncomeStatement(stockSymbol);
            setupNavigationButtons();
            setupToggleButtons();
        });

        function setupNavigationButtons() {
            const navButtons = {
                'navGeneral': 'general_info.html',
                'navIncome': 'income_statement.html',
                'navBalance': 'balance_sheet.html',
                'navRatings': 'ratings.html',
                'navEarnings': 'earnings.html',
                'navInsider': 'insider_trades.html',
                'navTargets': 'analyst_targets.html'
            };

            for (const [id, page] of Object.entries(navButtons)) {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        window.location.href = `${page}?stock=${stockSymbol}`;
                    });
                }
            }
        }

        function setupToggleButtons() {
            document.getElementById('toggleQuarterly').addEventListener('click', () => showData('quarterly'));
            document.getElementById('toggleYearly').addEventListener('click', () => showData('yearly'));
        }

        async function fetchIncomeStatement(symbol) {
            showLoading(true);
            try {
                const response = await fetch(`${backendBaseUrl}/tab2?stock=${symbol}`);
                
                if (!response.ok) {
                    const errorBody = await response.text(); 
                    console.error('Backend responded with non-OK status:', response.status, response.statusText, errorBody);
                    showError(`Failed to fetch income statement data. Server responded with status: ${response.status}.`);
                    return; 
                }

                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                } else {
                    incomeStatementData = data; 
                    showData('quarterly'); 
                    showLoading(false);
                    document.getElementById('incomeStatementContent').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error fetching income statement (network or JSON parse error):', error);
                if (error instanceof TypeError && error.message.includes('JSON')) {
                    try {
                        const responseClone = await fetch(`${backendBaseUrl}/tab2?stock=${symbol}`); 
                        const rawText = await responseClone.text();
                        console.error('Raw response text that caused JSON parsing error:', rawText);
                        showError('Failed to parse income statement data. The server might be returning non-JSON content. Check console for raw response.');
                    } catch (reFetchError) {
                        console.error('Error re-fetching for raw text:', reFetchError);
                        showError('A network error occurred while fetching income statement. Please check your internet connection or try again later.');
                    }
                } else {
                    showError('A network error occurred while fetching income statement. Please check your internet connection or try again later.');
                }
            }
        }

        function showData(period) {
            if (!incomeStatementData) return;

            const quarterlySection = document.getElementById('quarterlyData');
            const yearlySection = document.getElementById('yearlyData');
            const toggleQuarterlyBtn = document.getElementById('toggleQuarterly');
            const toggleYearlyBtn = document.getElementById('toggleYearly');

            if (period === 'quarterly') {
                quarterlySection.classList.remove('hidden');
                yearlySection.classList.add('hidden');
                toggleQuarterlyBtn.classList.add('active');
                toggleYearlyBtn.classList.remove('active');
                displayQuarterlyData(incomeStatementData);
            } else {
                yearlySection.classList.remove('hidden');
                quarterlySection.classList.add('hidden');
                toggleYearlyBtn.classList.add('active');
                toggleQuarterlyBtn.classList.remove('active');
                displayYearlyData(incomeStatementData);
            }
        }

        function displayQuarterlyData(data) {
            const quarterlyInfo = data['Quarterly Income Statement Info'];
            const quarterlyRatios = data['Quarterly Ratios'];

            if (!quarterlyInfo || !quarterlyInfo.dates || quarterlyInfo.dates.length === 0) {
                document.getElementById('quarterlyData').innerHTML = '<p class="text-center text-gray-500 mt-4">No quarterly data available.</p>';
                return;
            }

            const dates = quarterlyInfo.dates;
            const headerRow = document.getElementById('quarterlyHeaderRow');
            // Ensure all headers are centered except the first "Metric" one
            headerRow.innerHTML = '<th class="text-left">Metric</th>' + dates.map(date => `<th class="text-center">${date}</th>`).join('');

            const tableBody = document.getElementById('quarterlyTableBody');
            tableBody.innerHTML = ''; 

            const metrics = [
                'Revenue', 'Gross Profit', 'Operating Income', 'Ebitda', 'Net Income'
            ];
            const ratios = [
                'Net Profit Margin', 'Price to Sales Ratio'
            ];

            metrics.forEach(metric => {
                const row = document.createElement('tr');
                // First cell for metric name is left-aligned, subsequent data cells are centered
                row.innerHTML = `<td class="text-left">${metric}</td>` + dates.map((_, i) => `<td class="text-center">${formatNumber(quarterlyInfo[metric]?.[i]) || 'N/A'}</td>`).join('');
                tableBody.appendChild(row);
            });

            ratios.forEach(ratio => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="text-left">${ratio}</td>` + dates.map((_, i) => {
                    const cellValue = quarterlyRatios[ratio] && quarterlyRatios[ratio][i] !== undefined ? quarterlyRatios[ratio][i] : undefined;
                    if (ratio === 'Net Profit Margin') {
                        return `<td class="text-center">${formatPercentageDirect(cellValue) || 'N/A'}</td>`;
                    } else if (ratio === 'Price to Sales Ratio') {
                        return `<td class="text-center">${formatNumberDirect(cellValue) || 'N/A'}</td>`;
                    }
                    return `<td class="text-center">N/A</td>`;
                }).join('');
                tableBody.appendChild(row);
            });
        }

        function displayYearlyData(data) {
            const yearlyInfo = data['Yearly Income Statement Info'];
            const yearlyRatios = data['Yearly Ratios'];

            if (!yearlyInfo || (!yearlyInfo.Revenue && !yearlyInfo['Gross Profit'] && !yearlyInfo['Net Income'])) { 
                document.getElementById('yearlyData').innerHTML = '<p class="text-center text-gray-500 mt-4">No yearly data available.</p>';
                return;
            }

            const currentYear = new Date().getFullYear();
            const latestYear = currentYear; 

            const yearlyHeaderRow = document.getElementById('yearlyHeaderRow');
            // Ensure all headers are centered except the first "Metric" one
            yearlyHeaderRow.innerHTML = `<th class="text-left">Metric</th><th class="text-center">${latestYear}</th>`;

            const yearlyTableBody = document.getElementById('yearlyTableBody');
            yearlyTableBody.innerHTML = ''; 

            const metrics = [
                'Revenue', 'Gross Profit', 'Operating Income', 'Ebitda', 'Net Income'
            ];
            const ratios = [
                'Net Profit Margin', 'Price to Sales Ratio'
            ];

            const getValueForLatestYear = (key, dataObj) => {
                const value = dataObj[key];
                if (Array.isArray(value)) {
                    return value[value.length - 1]; 
                }
                return value; 
            };

            metrics.forEach(metric => {
                const row = document.createElement('tr');
                const value = getValueForLatestYear(metric, yearlyInfo);
                // First cell for metric name is left-aligned, subsequent data cells are centered
                row.innerHTML = `<td class="text-left">${metric}</td><td class="text-center">${formatNumber(value) || 'N/A'}</td>`;
                yearlyTableBody.appendChild(row);
            });

            ratios.forEach(ratio => {
                const row = document.createElement('tr');
                let formattedValue;
                const value = yearlyRatios[ratio];
                if (ratio === 'Net Profit Margin') {
                    formattedValue = formatPercentageFromDecimal(value);
                } else if (ratio === 'Price to Sales Ratio') {
                    formattedValue = formatNumberDirect(value);
                } else {
                    formattedValue = 'N/A';
                }
                // First cell for ratio name is left-aligned, subsequent data cells are centered
                row.innerHTML = `<td class="text-left">${ratio}</td><td class="text-center">${formattedValue || 'N/A'}</td>`;
                yearlyTableBody.appendChild(row);
            });
        }

        // Helper function to parse and format numbers, including those with B/M/K suffixes
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            
            let value = String(num).trim(); 

            const match = value.match(/^([\d.]+)([BMK]?)$/i);
            if (match) {
                let numericValue = parseFloat(match[1]);
                const suffix = match[2].toUpperCase();

                if (suffix === 'B') numericValue *= 1.0e+9;
                else if (suffix === 'M') numericValue *= 1.0e+6;
                else if (suffix === 'K') numericValue *= 1.0e+3;
                
                value = numericValue; 
            } else {
                value = Number(value); 
            }

            if (isNaN(value)) return 'N/A';

            const absValue = Math.abs(value);
            if (absValue >= 1.0e+9) {
                return (value / 1.0e+9).toFixed(2) + "B";
            }
            if (absValue >= 1.0e+6) {
                return (value / 1.0e+6).toFixed(2) + "M";
            }
            if (absValue >= 1.0e+3) {
                return (value / 1.0e+3).toFixed(2) + "K";
            }
            return value.toFixed(2);
        }

        // Helper function for percentages that are already scaled (e.g., 29.24)
        function formatPercentageDirect(num) {
            if (num === null || num === undefined) return 'N/A';
            num = Number(num);
            if (isNaN(num)) return 'N/A';
            return num.toFixed(2) + '%';
        }

        // Helper function for percentages that are decimals (e.g., 0.29)
        function formatPercentageFromDecimal(num) {
            if (num === null || num === undefined) return 'N/A';
            num = Number(num);
            if (isNaN(num)) return 'N/A';
            return (num * 100).toFixed(2) + '%';
        }

        // Helper function to format numbers directly (e.g., 22.15)
        function formatNumberDirect(num) {
            if (num === null || num === undefined) return 'N/A';
            num = Number(num);
            if (isNaN(num)) return 'N/A';
            return num.toFixed(2);
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            document.getElementById('incomeStatementContent').classList.toggle('hidden', show);
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('incomeStatementContent').classList.add('hidden');
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }
    </script>
</body>
</html>
