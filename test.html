<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockSight</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Text&family=Roboto+Mono:wght@200&display=swap" rel="stylesheet">
<style>
    /* Define a custom color palette */
    :root {
      --bg-gray: #f3f4f6;
      --card-bg: #ffffff;
      --blue-accent: #2563eb;
      --green-accent: #10b981;
    }

    body {
      font-family: 'Roboto Mono', monospace;
      background-color: var(--bg-gray);
      font-weight: 200; /* Apply extralight weight */
    }

    .font-dm-serif {
      font-family: 'DM Serif Text', serif;
      font-weight: 400; /* Apply regular weight */
    }

    .card-shadow {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                  0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .news-card {
      @apply flex flex-col bg-white p-4 rounded-xl card-shadow transition-shadow duration-200 hover:shadow-xl;
    }

    .loading-spinner {
      border-top-color: #2563eb;
    }
</style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4 sm:p-6">
    <div class="w-full max-w-6xl mx-auto flex flex-col gap-12">

        <header class="w-full text-center py-8 rounded-2xl bg-gradient-to-r from-gray-50 to-gray-200 card-shadow relative">
      <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 mb-2 font-dm-serif">StockSight</h1>
      <button onclick="signOutUser()" class="absolute top-6 right-6 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
        Sign Out
      </button>

            <button id="getPremiumBtn"
        onclick="goToPricing()"
        class="mt-4 bg-blue-800 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:bg-blue-900 transition duration-300 ease-in-out transform hover:scale-105">
        Get Premium
      </button>
    </header>

        <main class="w-full grid grid-cols-1 md:grid-cols-2 gap-8">

            <div class="bg-white p-8 rounded-2xl card-shadow flex flex-col items-center text-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 font-dm-serif">Search Stock by Symbol</h2>
        <div class="flex flex-col gap-6 w-full max-w-sm">
          <input type="text" id="stockSymbolInput" placeholder="e.g., AAPL, GOOG"
            class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
          <button id="searchStockBtn"
            class="w-full bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105">
            View Stock Info
          </button>
        </div>

                <div id="validationMessage"
          class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-6 transition-all duration-300 transform scale-95"
          role="alert">
          <span id="validationText"></span>
        </div>
      </div>

            <div class="bg-white p-8 rounded-2xl card-shadow flex flex-col items-center text-center">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 font-dm-serif">View Calendar by Date</h2>
        <div class="flex flex-col gap-6 w-full max-w-sm">
          <div class="flex flex-col text-left">
            <label for="calendarDate" class="text-gray-700 font-medium mb-1">Select Date:</label>
            <input type="date" id="calendarDate"
              class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
          </div>

          <div class="flex flex-col text-left">
            <label for="calendarTypeSelect" class="text-gray-700 font-medium mb-1">Select Calendar Type:</label>
            <select id="calendarTypeSelect"
              class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
              <option value="earnings_calendar.html">Upcoming/Historical Earnings Calendar</option>
              <option value="ipos_calendar.html">Upcoming/Historical IPO Calendar</option>
              <option value="split_calendar.html">Upcoming/Historical Split Calendar</option>
              <option value="dividend_calendar.html">Upcoming/Historical Dividend Calendar</option>
            </select>
          </div>

                    <div id="calendarErrorMessage"
            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-4"
            role="alert">
            <span id="calendarErrorText"></span>
          </div>

          <button id="viewCalendarBtn"
            class="w-full bg-green-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 mt-2">
            View Calendar
          </button>
        </div>
      </div>
    </main>

        <div id="loadingIndicator" class="text-center my-10 hidden">
      <div class="bg-white p-10 rounded-2xl card-shadow flex flex-col items-center">
        <div class="loading-spinner border-4 border-gray-200 border-t-blue-500 rounded-full w-12 h-12 animate-spin"></div>
        <p class="mt-4 text-xl font-medium text-gray-600">Loading Market Data...</p>
      </div>
    </div>

        <div id="errorMessage"
      class="hidden my-10 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-2xl card-shadow text-center">
      <strong class="font-bold">Oops!</strong>
      <span class="block sm:inline" id="errorText">An error occurred while loading data. Please try again.</span>
    </div>

        <section id="generalNewsSection" class="w-full hidden">
      <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center font-dm-serif">General Market News</h2>
      <div id="newsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              </div>
    </section>

        <section id="marketSummarySection" class="w-full grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            <div class="bg-white p-8 rounded-2xl card-shadow">
        <h3 class="text-2xl font-bold text-green-600 mb-4 text-center font-dm-serif">Top Gainers</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left text-gray-600 font-semibold rounded-tl-xl w-1/2">Stock</th>
                <th class="px-4 py-2 text-left text-gray-600 font-semibold w-1/4">Price</th>
                <th class="px-4 py-2 text-right text-gray-600 font-semibold rounded-tr-xl w-1/4">Change (%)</th>
              </tr>
            </thead>
            <tbody id="gainersList">
                          </tbody>
          </table>
        </div>
      </div>

            <div class="bg-white p-8 rounded-2xl card-shadow">
        <h3 class="text-2xl font-bold text-red-600 mb-4 text-center font-dm-serif">Top Losers</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left text-gray-600 font-semibold rounded-tl-xl w-1/2">Stock</th>
                <th class="px-4 py-2 text-left text-gray-600 font-semibold w-1/4">Price</th>
                <th class="px-4 py-2 text-right text-gray-600 font-semibold rounded-tr-xl w-1/4">Change (%)</th>
              </tr>
            </thead>
            <tbody id="losersList">
                          </tbody>
          </table>
        </div>
      </div>

            <div class="bg-white p-8 rounded-2xl card-shadow">
        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center font-dm-serif">Most Active Stocks</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left text-gray-600 font-semibold rounded-tl-xl w-1/2">Stock</th>
                <th class="px-4 py-2 text-left text-gray-600 font-semibold w-1/4">Price</th>
                <th class="px-4 py-2 text-right text-gray-600 font-semibold rounded-tr-xl w-1/4">Change (%)</th>
              </tr>
            </thead>
            <tbody id="mostActiveList">
                          </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

      <script type="module">
      // Import the functions you need from the SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
      // Import Firestore functions
      import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBFBOe8Op4jPw4SR6Yla3hs-y4xzqDApoY",
        authDomain: "stocksight-75940.firebaseapp.com",
        projectId: "stocksight-75940",
        storageBucket: "stocksight-75940.firebasestorage.app",
        messagingSenderId: "223645254786",
        appId: "1:223645254786:web:14c980e559d9090f89e09b",
        measurementId: "G-8JGEEE9KD1"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);
    
      // Check if user is logged in
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("User is signed in:", user.email);
    
          // Create a document reference in a 'users' collection using the user's UID as the document ID
          const userDocRef = doc(db, "users", user.uid);
    
          // Data to save to Firestore. This will set isPremium to false for new users.
          const userData = {
            email: user.email,
            lastLoginAt: user.metadata.lastSignInTime,
            isPremium: false
          };
    
          try {
            // Use setDoc with { merge: true } to create the document with isPremium: false
            // for new users, but only update the lastLoginAt for returning users,
            // leaving their existing isPremium status untouched.
            await setDoc(userDocRef, userData, { merge: true });
            console.log("User data successfully saved to Firestore!");
          } catch (e) {
            console.error("Error writing user data to Firestore:", e);
          }
    
        } else {
          // Not logged in, redirect to auth page
          window.location.href = "auth.html";
        }
      });
    
      // Sign out function
      window.signOutUser = async function() {
        try {
          await signOut(auth);
          window.location.href = "auth.html";
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };
    
      window.goToPricing = function() {
        window.location.href = "pricing.html";
      };
    
      // Custom function to show a styled message instead of alert()
      function showMessage(message, type, targetElementId) {
        const messageBox = document.getElementById(targetElementId);
        const messageText = messageBox.querySelector('span');
        messageText.textContent = message;
        messageBox.className = `bg-${type}-100 border border-${type}-400 text-${type}-700 px-4 py-3 rounded-xl relative mt-6 transition-all duration-300 transform scale-100`;
        messageBox.classList.remove('hidden');
        setTimeout(() => {
          messageBox.classList.add('hidden');
        }, 5000); // Hide after 5 seconds
      }
    
      document.addEventListener('DOMContentLoaded', () => {
        // Set default date for the new calendar input field to today
        const today = new Date();
        document.getElementById('calendarDate').value = today.toISOString().split('T')[0];
    
        // Stock Search Button Logic
        document.getElementById('searchStockBtn').addEventListener('click', async () => {
          const stockSymbolInput = document.getElementById('stockSymbolInput');
          const symbol = stockSymbolInput.value.trim().toUpperCase();
    
          if (symbol.length === 0) {
            showMessage('Please enter a stock symbol.', 'red', 'validationMessage');
            return;
          }
    
          const loadingIndicator = document.getElementById('loadingIndicator');
          loadingIndicator.classList.remove('hidden');
    
          try {
            const validationApiUrl = `https://stock-backend-0128.onrender.com/check?stock=${symbol}`;
            let response;
            let attempts = 0;
            const maxAttempts = 3;
            const baseDelay = 1000;
    
            while (attempts < maxAttempts) {
              try {
                response = await fetch(validationApiUrl);
                if (response.ok) {
                  break;
                } else {
                  throw new Error(`HTTP Error: ${response.status}`);
                }
              } catch (error) {
                attempts++;
                if (attempts < maxAttempts) {
                  const delay = baseDelay * (2 ** attempts);
                  console.error(`Attempt ${attempts} failed. Retrying in ${delay / 1000}s...`, error);
                  await new Promise(res => setTimeout(res, delay));
                } else {
                  throw error;
                }
              }
            }
    
            const data = await response.json();
    
            if (data['valid?'] === 1) {
              window.location.href = `general_info.html?stock=${symbol}`;
            } else if (data['error']) {
              showMessage(data['error'], 'red', 'validationMessage');
            } else {
              showMessage('Please enter a valid stock symbol.', 'red', 'validationMessage');
            }
          } catch (error) {
            console.error("Failed to validate stock symbol:", error);
            showMessage(
              'error: please enter a valid stock symbol.',
              'red',
              'validationMessage'
            );
          } finally {
            loadingIndicator.classList.add('hidden');
          }
        });
    
        // View Calendar Button Logic
        document.getElementById('viewCalendarBtn').addEventListener('click', () => {
          const selectedDate = document.getElementById('calendarDate').value;
          const selectedCalendarTypeFile = document.getElementById('calendarTypeSelect').value;
          const errorMessageDiv = document.getElementById('calendarErrorMessage');
          const errorTextSpan = document.getElementById('calendarErrorText');
    
          errorMessageDiv.classList.add('hidden');
    
          if (!selectedDate) {
            errorTextSpan.textContent = 'Please select a date for the calendar.';
            errorMessageDiv.classList.remove('hidden');
            return;
          }
    
          if (!selectedCalendarTypeFile) {
            errorTextSpan.textContent = 'Please select a calendar type.';
            errorMessageDiv.classList.remove('hidden');
            return;
          }
    
          window.location.href = `${selectedCalendarTypeFile}?date=${selectedDate}`;
        });
    
        // =========================================================================
        // CODE FOR DYNAMIC MARKET DATA
        // =========================================================================
        const API_URL = "https://stock-backend-0128.onrender.com/tabzero";
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageDiv = document.getElementById('errorMessage');
        const errorTextSpan = document.getElementById('errorText');
        const newsContainer = document.getElementById('newsContainer');
        const gainersList = document.getElementById('gainersList');
        const losersList = document.getElementById('losersList');
        const mostActiveList = document.getElementById('mostActiveList');
        const generalNewsSection = document.getElementById('generalNewsSection');
        const marketSummarySection = document.getElementById('marketSummarySection');
    
        function formatNumber(num, decimals) {
          return parseFloat(num).toFixed(decimals);
        }
    
        function renderStocks(stockData, containerElement) {
          containerElement.innerHTML = '';
          if (stockData && stockData.length > 0) {
            stockData.slice(0, 10).forEach(stock => {
              const changeColor = stock['Change (%)'] >= 0 ? 'text-green-600' : 'text-red-600';
              const changeSign = stock['Change (%)'] >= 0 ? '+' : '';
              const stockRowHtml = `
                <tr class="border-b last:border-b-0 border-gray-200 hover:bg-gray-50 transition-colors duration-150">
                  <td class="px-4 py-3 font-medium text-gray-800 w-1/2">
                    ${stock.Stock} <span class="text-xs text-gray-400">(${stock.Exchange})</span>
                  </td>
                  <td class="px-4 py-3 text-gray-700 w-1/4">${formatNumber(stock.Price, 2)}</td>
                  <td class="px-4 py-3 text-right font-semibold ${changeColor} w-1/4">
                    ${changeSign}${formatNumber(stock['Change (%)'], 2)}%
                  </td>
                </tr>`;
              containerElement.innerHTML += stockRowHtml;
            });
          }
        }
    
        function renderNews(newsData) {
          newsContainer.innerHTML = '';
          if (newsData && newsData.length > 0) {
            generalNewsSection.classList.remove('hidden');
            newsData.forEach(newsItem => {
              let newsCardHtml;
              if (newsItem.Image) {
                // Render with image if available
                newsCardHtml = `
                  <div class="news-card">
                    <img src="${newsItem.Image}" alt="News image" onerror="this.onerror=null;this.src='https://placehold.co/400x200/e5e7eb/4b5563?text=Image+Not+Available';" class="w-full h-48 object-cover rounded-xl mb-4">
                    <h4 class="text-lg font-bold text-gray-800 line-clamp-2 mb-2"><a href="${newsItem.url}" target="_blank" class="hover:underline">${newsItem.Title}</a></h4>
                    <p class="text-sm text-gray-500 mb-2">${newsItem.Publisher}</p>
                    <p class="text-sm text-gray-400 mt-auto">${newsItem.Date.split(' ')[0]}</p>
                  </div>
                `;
              } else {
                // Render a smaller card without an image
                newsCardHtml = `
                  <div class="news-card">
                    <h4 class="text-lg font-bold text-gray-800 mb-2"><a href="${newsItem.url}" target="_blank" class="hover:underline">${newsItem.Title}</a></h4>
                    <p class="text-sm text-gray-500 mb-2">${newsItem.Publisher}</p>
                    <p class="text-sm text-gray-400 mt-auto">${newsItem.Date.split(' ')[0]}</p>
                  </div>
                `;
              }
              newsContainer.innerHTML += newsCardHtml;
            });
          }
        }
    
        /**
         * Fetches and displays the market data from the backend.
         */
        async function fetchMarketData() {
          loadingIndicator.classList.remove('hidden');
          errorMessageDiv.classList.add('hidden');
          generalNewsSection.classList.add('hidden');
          marketSummarySection.classList.add('hidden');
    
          try {
            let response;
            let attempts = 0;
            const maxAttempts = 3;
            const baseDelay = 1000;
    
            // Implement exponential backoff for API calls
            while (attempts < maxAttempts) {
              try {
                response = await fetch(API_URL);
                if (response.ok) {
                  break;
                } else {
                  throw new Error(`HTTP Error: ${response.status}`);
                }
              } catch (error) {
                attempts++;
                if (attempts < maxAttempts) {
                  const delay = baseDelay * (2 ** attempts);
                  console.error(`Attempt ${attempts} failed. Retrying in ${delay / 1000}s...`, error);
                  await new Promise(res => setTimeout(res, delay));
                } else {
                  throw error;
                }
              }
            }
    
            const data = await response.json();
    
            if (data['General News'] && data['General News'].length > 0) {
              renderNews(data['General News']);
            }
            if (data['Top Gainers'] && data['Top Gainers'].length > 0) {
              renderStocks(data['Top Gainers'], gainersList);
            }
            if (data['Top Losers'] && data['Top Losers'].length > 0) {
              renderStocks(data['Top Losers'], losersList);
            }
            if (data['Most Active'] && data['Most Active'].length > 0) {
              renderStocks(data['Most Active'], mostActiveList);
            }
    
            // Show the sections if data was successfully rendered
            if (data['General News'] && data['General News'].length > 0) {
              generalNewsSection.classList.remove('hidden');
            }
            if (data['Top Gainers'] && data['Top Gainers'].length > 0 ||
              data['Top Losers'] && data['Top Losers'].length > 0 ||
              data['Most Active'] && data['Most Active'].length > 0) {
              marketSummarySection.classList.remove('hidden');
            }
          } catch (error) {
            console.error("Failed to fetch market data:", error);
            errorTextSpan.textContent = `An error occurred: ${error.message}. Please try again later.`;
            errorMessageDiv.classList.remove('hidden');
          } finally {
            loadingIndicator.classList.add('hidden');
          }
        }
    
        // Call the function to fetch data on page load
        fetchMarketData();
      });
    </script>
</body>
</html>
