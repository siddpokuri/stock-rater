<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Info - Ratings</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A very light gray background */
        }
        /* Custom styles for the table header */
        .table-header {
            background-color: #f3f4f6; /* light gray background */
            font-weight: 600; /* semi-bold */
            color: #4b5563; /* darker gray text */
        }
        /* Custom styles for table rows */
        .table-row-odd {
            background-color: #ffffff; /* white background */
        }
        .table-row-even {
            background-color: #f9fafb; /* slightly off-white for striping */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-center items-center">
            <div class="flex flex-wrap justify-center space-x-4 sm:space-x-8 text-gray-600 font-semibold">
                <!-- Navigation items with dynamic hrefs set by JavaScript -->
                <a href="index.html" class="text-green-600 font-semibold hover:text-blue-600 transition-colors duration-300">Home</a>
                <a href="#" id="nav-general-info" class="hover:text-blue-600 transition-colors duration-300">General Info</a>
                <a href="#" id="nav-income-statement" class="hover:text-blue-600 transition-colors duration-300">Income Statement</a>
                <a href="#" id="nav-cash-flow" class="hover:text-blue-600 transition-colors duration-300">Cash Flow</a>
                <a href="#" id="nav-balance-sheet" class="hover:text-blue-600 transition-colors duration-300">Balance Sheet</a>
                <a href="#" id="nav-ratings" class="text-blue-700 font-bold transition-colors duration-300">Ratings</a>
                <a href="#" id="nav-earnings" class="hover:text-blue-600 transition-colors duration-300">Earnings</a>
                <a href="#" id="nav-insider-trades" class="hover:text-blue-600 transition-colors duration-300">Insider Trades</a>
                <a href="#" id="nav-analyst-targets" class="hover:text-blue-600 transition-colors duration-300">Analyst Targets</a>
                <a href="#" id="nav-recent-news" class="hover:text-blue-600 transition-colors duration-300">Recent News</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        <!-- Dynamic Title -->
        <h1 id="stockTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">Stock Ratings</h1>

        <!-- Toggle Buttons -->
        <div class="flex justify-center mb-6">
            <button id="showCurrentRatings" class="px-6 py-3 rounded-l-full font-bold text-white bg-blue-600 hover:bg-blue-700 transition-colors">Current Ratings</button>
            <button id="showPastRatings" class="px-6 py-3 rounded-r-full font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors">Past-to-Current Ratings</button>
        </div>

        <div id="loadingIndicator" class="text-center text-gray-600 text-lg mt-10">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-e-transparent align-[-0.125em] text-blue-500 motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status">
                <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
            </div>
        </div>

        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-10" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="errorText"></span>
        </div>

        <!-- Container for Current Ratings -->
        <div id="currentRatingsContainer" class="hidden max-w-4xl mx-auto space-y-8">
            <!-- Overall Ratings Section -->
            <div id="overallRatingsSection" class="bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Core Ratings</h2>
                <div id="coreRatings" class="divide-y divide-gray-200">
                    <!-- Core ratings will be inserted here -->
                </div>
            </div>

            <!-- Fundamental Ratings Section -->
            <div id="fundamentalRatingsSection" class="bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Fundamental Ratings</h2>
                <div id="otherRatings" class="divide-y divide-gray-200">
                    <!-- Other ratings will be inserted here -->
                </div>
            </div>

            <!-- Consensus Summary Section -->
            <div id="consensusSection" class="bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Consensus Summary</h2>
                <div id="consensusSummary" class="flex flex-col md:flex-row justify-around text-center space-y-4 md:space-y-0">
                    <!-- Consensus data will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Container for Past-to-Current Ratings -->
        <div id="pastRatingsContainer" class="hidden max-w-4xl mx-auto space-y-8">
            <!-- Historical Ratings Section -->
            <div id="historicalRatingsSection" class="bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Historical Ratings</h2>
                <div id="historicalRatingsTableContainer" class="overflow-x-auto">
                    <!-- Historical Ratings table will be inserted here -->
                </div>
            </div>

            <!-- Upgrades/Downgrades Section -->
            <div id="upgradesDowngradesSection" class="bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Analyst Upgrades/Downgrades</h2>
                <div id="upgradesTableContainer" class="overflow-x-auto">
                    <!-- Upgrades/Downgrades table will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        let stockSymbol = '';
        const backendBaseUrl = 'https://stock-backend-0128.onrender.com';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            stockSymbol = urlParams.get('stock');
            
            const navLinks = [
                { id: 'nav-general-info', file: 'general_info.html' },
                { id: 'nav-income-statement', file: 'income_statement.html' },
                { id: 'nav-cash-flow', file: 'cash_flow.html' },
                { id: 'nav-balance-sheet', file: 'balance_sheet.html' },
                { id: 'nav-ratings', file: 'ratings.html' },
                { id: 'nav-earnings', file: 'earnings.html' },
                { id: 'nav-insider-trades', file: 'insider_trades.html' },
                { id: 'nav-analyst-targets', file: 'analyst_targets.html' },
                { id: 'nav-recent-news', file: 'recent_news.html' },
            ];

            if (!stockSymbol) {
                showError('No stock symbol provided in the URL.');
                return;
            }

            // Update navigation bar hrefs
            navLinks.forEach(link => {
                const navElement = document.getElementById(link.id);
                if (navElement) {
                    navElement.href = `${link.file}?stock=${stockSymbol}`;
                }
            });
            
            fetchRatings(stockSymbol);

            // Add event listeners for the toggle buttons
            document.getElementById('showCurrentRatings').addEventListener('click', () => switchRatingsView('current'));
            document.getElementById('showPastRatings').addEventListener('click', () => switchRatingsView('past'));
        });

        // Toggles between the two rating views
        function switchRatingsView(view) {
            const currentBtn = document.getElementById('showCurrentRatings');
            const pastBtn = document.getElementById('showPastRatings');
            const currentContainer = document.getElementById('currentRatingsContainer');
            const pastContainer = document.getElementById('pastRatingsContainer');

            if (view === 'current') {
                currentContainer.classList.remove('hidden');
                pastContainer.classList.add('hidden');
                currentBtn.classList.remove('bg-gray-200', 'text-gray-700');
                currentBtn.classList.add('bg-blue-600', 'text-white');
                pastBtn.classList.remove('bg-blue-600', 'text-white');
                pastBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                pastContainer.classList.remove('hidden');
                currentContainer.classList.add('hidden');
                pastBtn.classList.remove('bg-gray-200', 'text-gray-700');
                pastBtn.classList.add('bg-blue-600', 'text-white');
                currentBtn.classList.remove('bg-blue-600', 'text-white');
                currentBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
        }

        // Helper function to get Tailwind CSS color class based on rating text
        function getRatingColorClass(ratingText) {
            if (!ratingText) return 'text-gray-700';

            const lowerRating = String(ratingText).toLowerCase();

            // Green for A grades and Strong Buy/Buy
            if (lowerRating === 'a' || lowerRating === 'a+' || lowerRating === 'a-' || lowerRating.includes('strong buy') || lowerRating.includes('buy') || lowerRating.includes('outperform') || lowerRating.includes('overweight') || lowerRating.includes('sector outperform') || lowerRating.includes('market outperform')) {
                return 'text-green-600';
            }
            // Yellow for B grades and Hold/Neutral
            if (lowerRating === 'b' || lowerRating === 'b+' || lowerRating === 'b-' || lowerRating.includes('hold') || lowerRating.includes('peer perform') || lowerRating.includes('market perform') || lowerRating.includes('neutral')) {
                return 'text-yellow-500';
            }
            // Orange for C grades
            if (lowerRating === 'c' || lowerRating === 'c+' || lowerRating === 'c-') {
                return 'text-orange-500';
            }
            // Red for D/F grades and Sell
            if (lowerRating === 'd' || lowerRating === 'f' || lowerRating.includes('sell') || lowerRating.includes('strong sell') || lowerRating.includes('underperform')) {
                return 'text-red-600';
            }
            
            return 'text-gray-700'; // Neutral gray
        }

        // Main function to fetch and display all rating data
        async function fetchRatings(symbol) {
            showLoading(true);
            try {
                let response = null;
                let delay = 1000;
                const maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(`${backendBaseUrl}/tab4?stock=${symbol}`);
                    if (response.ok) {
                        break;
                    }
                    if (response.status === 429) {
                        console.warn(`API call failed with status 429. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`API call failed with status ${response.status}`);
                    }
                }
                
                if (!response || !response.ok) {
                    const errorBody = response ? await response.text() : 'No response';
                    console.error('Backend responded with non-OK status:', response ? response.status : 'N/A', response ? response.statusText : 'N/A', errorBody);
                    throw new Error(`Failed to fetch ratings data. Server responded with status: ${response ? response.status : 'N/A'}.`);
                }

                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                } else {
                    displayAllRatings(data);
                    showLoading(false);
                    switchRatingsView('current'); // Show current ratings by default
                }
            } catch (error) {
                console.error('Error fetching ratings:', error);
                showError('A network error occurred while fetching ratings. Please check your internet connection or try again later.');
            }
        }
        
        // New function to handle all display logic based on the updated JSON structure
        function displayAllRatings(data) {
            // Display core ratings, including Overall Rating and Consensus
            const coreRatingsElement = document.getElementById('coreRatings');
            coreRatingsElement.innerHTML = '';
            
            const coreMetrics = [
                { key: 'Overall Rating', source: data['Other Ratings'] },
                { key: 'Consensus', source: data['Consensus Summary'] },
                { key: 'Valuation', source: data['Core Ratings'] },
                { key: 'Stability', source: data['Core Ratings'] },
                { key: 'Profitability', source: data['Core Ratings'] },
                { key: 'Growth', source: data['Core Ratings'] }
            ];

            coreMetrics.forEach(metric => {
                const value = metric.source ? metric.source[metric.key] : 'N/A';
                if (value !== undefined && value !== null) {
                    appendRatingItem(coreRatingsElement, metric.key, value);
                }
            });

            // Display other fundamental ratings
            const otherRatingsElement = document.getElementById('otherRatings');
            otherRatingsElement.innerHTML = '';

            const otherMetricsOrder = ["Debt to Equity Rating", "PE Ratio Rating", "ROA Rating", "ROE Rating"];

            const otherRatingsData = data['Other Ratings'];
            if (!otherRatingsData || Object.keys(otherRatingsData).length === 0) {
                otherRatingsElement.innerHTML = '<p class="text-center text-gray-500 py-4">No fundamental ratings data available.</p>';
            } else {
                otherMetricsOrder.forEach(metric => {
                    const value = otherRatingsData[metric];
                    if (value !== undefined && value !== null) {
                        appendRatingItem(otherRatingsElement, metric, value);
                    }
                });
            }
            
            // Corrected line: Display consensus summary
            displayConsensusSummary(data['Consensus Summary']);

            // Display upgrades and downgrades
            displayUpgradesDowngrades(data['Upgrades/Downgrades']);

            // Display historical ratings
            displayHistoricalRatings(data['Historical Ratings']);
        }

        // Creates a list item for a rating
        function appendRatingItem(parent, metric, value) {
            const listItem = document.createElement('div');
            listItem.className = 'flex justify-between items-center py-3';
            
            const metricNameSpan = document.createElement('span');
            metricNameSpan.textContent = `${metric}:`;
            metricNameSpan.className = 'text-lg font-semibold text-gray-700';
            
            const ratingValueSpan = document.createElement('span');
            ratingValueSpan.textContent = value;
            ratingValueSpan.className = `text-xl font-bold ${getRatingColorClass(value)}`;
            
            listItem.appendChild(metricNameSpan);
            listItem.appendChild(ratingValueSpan);
            parent.appendChild(listItem);
        }

        // Displays the consensus summary from the backend data
        function displayConsensusSummary(data) {
            const consensusSummaryElement = document.getElementById('consensusSummary');
            consensusSummaryElement.innerHTML = '';

            if (!data || Object.keys(data).length === 0) {
                consensusSummaryElement.innerHTML = '<p class="text-center text-gray-500 py-4">No consensus data available.</p>';
                return;
            }

            const consensusOrder = ["# Strong Buy", "# Buy", "# Hold", "# Sell", "# Strong Sell"];
            
            consensusOrder.forEach(key => {
                const value = data[key];
                if (value !== undefined) {
                    const item = document.createElement('div');
                    item.className = 'flex flex-col items-center p-4 bg-gray-50 rounded-xl shadow-inner w-full md:w-auto';
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.textContent = value;
                    valueSpan.className = `text-3xl font-bold ${getRatingColorClass(key.replace('# ', ''))}`;
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.textContent = key.replace('# ', ''); // Remove the '#' for the label
                    labelSpan.className = 'text-sm font-medium text-gray-600 mt-1';
                    
                    item.appendChild(valueSpan);
                    item.appendChild(labelSpan);
                    consensusSummaryElement.appendChild(item);
                }
            });
        }

        // Renders the table for analyst upgrades and downgrades
        function displayUpgradesDowngrades(data) {
            const container = document.getElementById('upgradesTableContainer');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">No recent upgrades or downgrades available.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full table-auto rounded-xl overflow-hidden shadow">
                    <thead>
                        <tr class="table-header">
                            <th class="py-3 px-4 text-left">Date</th>
                            <th class="py-3 px-4 text-left">Company</th>
                            <th class="py-3 px-4 text-left">Action</th>
                            <th class="py-3 px-4 text-left">New Grade</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;
            
            data.forEach((item, index) => {
                const rowClass = index % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                tableHtml += `
                    <tr class="${rowClass}">
                        <td class="py-3 px-4">${item.Date}</td>
                        <td class="py-3 px-4">${item.Company}</td>
                        <td class="py-3 px-4">${item.Action}</td>
                        <td class="py-3 px-4 ${getRatingColorClass(item['New Grade'])} font-bold">${item['New Grade']}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHtml;
        }

        // Renders the table for historical ratings
        function displayHistoricalRatings(data) {
            const container = document.getElementById('historicalRatingsTableContainer');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">No historical ratings data available.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full table-auto rounded-xl overflow-hidden shadow">
                    <thead>
                        <tr class="table-header">
                            <th class="py-3 px-4 text-left">Date</th>
                            <th class="py-3 px-4 text-left">Overall</th>
                            <th class="py-3 px-4 text-left">ROE</th>
                            <th class="py-3 px-4 text-left">ROA</th>
                            <th class="py-3 px-4 text-left">P/E</th>
                            <th class="py-3 px-4 text-left">D/E</th>
                            <th class="py-3 px-4 text-left">P/B</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;
            
            data.forEach((item, index) => {
                const rowClass = index % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                tableHtml += `
                    <tr class="${rowClass}">
                        <td class="py-3 px-4">${item.Date}</td>
                        <td class="py-3 px-4 ${getRatingColorClass(item['Overall Rating'])} font-bold">${item['Overall Rating']}</td>
                        <td class="py-3 px-4 ${getRatingColorClass(item['ROE Score'])} font-bold">${item['ROE Score']}</td>
                        <td class="py-3 px-4 ${getRatingColorClass(item['ROA Score'])} font-bold">${item['ROA Score']}</td>
                        <td class="py-3 px-4 ${getRatingColorClass(item['Price-to-Earnings Score'])} font-bold">${item['Price-to-Earnings Score']}</td>
                        <td class="py-3 px-4 ${getRatingColorClass(item['Debt-to-Equity Score'])} font-bold">${item['Debt-to-Equity Score']}</td>
                        <td class="py-3 px-4 ${getRatingColorClass(item['Price-to-Book Score'])} font-bold">${item['Price-to-Book Score']}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHtml;
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            document.getElementById('currentRatingsContainer').classList.toggle('hidden', show);
            document.getElementById('pastRatingsContainer').classList.toggle('hidden', show);
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('currentRatingsContainer').classList.add('hidden');
            document.getElementById('pastRatingsContainer').classList.add('hidden');
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }
    </script>
</body>
</html>
