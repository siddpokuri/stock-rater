<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockSight</title>

    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Professional font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Dark background */
            color: #E5E7EB; /* Light text */
        }
        .card-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .news-card {
            @apply flex flex-col bg-zinc-900 p-6 rounded-2xl card-shadow transition-shadow duration-300 hover:shadow-2xl;
        }
        .loading-spinner {
            border-top-color: #60A5FA;
        }
        .text-gradient {
            background-image: linear-gradient(to right, #6EE7B7, #3B82F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .market-table thead tr {
            background-color: #374151;
        }
        .market-table th, .market-table td {
            @apply px-4 py-3;
        }
        .market-table th {
            @apply text-left text-xs font-medium uppercase tracking-wider text-gray-300 rounded-lg;
        }
        .market-table tr:hover {
            background-color: #2D3748;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-8">

    <!-- Main Container -->
    <div class="w-full max-w-7xl mx-auto flex flex-col gap-16">

        <!-- Header Section -->
        <header class="w-full text-center py-16 rounded-3xl bg-zinc-900 shadow-2xl relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-gray-900 to-gray-800 opacity-50"></div>
            <div class="relative z-10">
                <h1 class="text-5xl sm:text-6xl font-semibold leading-tight text-gradient mb-2">StockSight</h1>
            </div>
            <button onclick="signOutUser()" class="absolute top-6 right-6 bg-red-600 text-white font-semibold px-4 py-2 rounded-xl shadow-md hover:bg-red-700 transition">
                Sign Out
            </button>
            <button id="getPremiumBtn"
                onclick="goToPricing()"
                class="absolute bottom-6 right-6 bg-indigo-600 text-white font-semibold px-6 py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                Get Premium
            </button>
        </header>

        <!-- Main Content Grid -->
        <main class="w-full grid grid-cols-1 md:grid-cols-2 gap-10">

            <!-- Stock Search Section -->
            <div class="bg-zinc-900 p-10 rounded-3xl card-shadow flex flex-col items-center text-center">
                <h2 class="text-3xl font-semibold text-gray-200 mb-6">Search Stock by Symbol</h2>
                <div class="flex flex-col gap-6 w-full max-w-sm">
                    <input type="text" id="stockSymbolInput" placeholder="e.g., AAPL, GOOG"
                        class="w-full px-5 py-3 border border-gray-700 bg-zinc-800 text-white rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    <button id="searchStockBtn"
                        class="w-full bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition transform hover:scale-105">
                        View Stock Info
                    </button>
                </div>
                <!-- Custom Message Box for validation errors -->
                <div id="validationMessage"
                    class="hidden bg-red-900 border-l-4 border-red-500 text-red-300 px-6 py-4 rounded-xl relative mt-8 transition-all duration-300 transform"
                    role="alert">
                    <span id="validationText" class="font-medium"></span>
                </div>
            </div>

            <!-- Calendar Selection Section -->
            <div class="bg-zinc-900 p-10 rounded-3xl card-shadow flex flex-col items-center text-center">
                <h2 class="text-3xl font-semibold text-gray-200 mb-6">View Calendar by Date</h2>
                <div class="flex flex-col gap-6 w-full max-w-sm">
                    <div class="flex flex-col text-left">
                        <label for="calendarDate" class="text-gray-300 font-medium mb-1">Select Date:</label>
                        <input type="date" id="calendarDate"
                            class="w-full px-5 py-3 border border-gray-700 bg-zinc-800 text-white rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300">
                    </div>
                    <div class="flex flex-col text-left">
                        <label for="calendarTypeSelect" class="text-gray-300 font-medium mb-1">Select Calendar Type:</label>
                        <select id="calendarTypeSelect"
                            class="w-full px-5 py-3 border border-gray-700 bg-zinc-800 text-white rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300">
                            <option value="earnings_calendar.html">Upcoming/Historical Earnings</option>
                            <option value="ipos_calendar.html">Upcoming/Historical IPOs</option>
                            <option value="split_calendar.html">Upcoming/Historical Splits</option>
                            <option value="dividend_calendar.html">Upcoming/Historical Dividends</option>
                        </select>
                    </div>
                    <!-- Error Message for Calendar -->
                    <div id="calendarErrorMessage"
                        class="hidden bg-red-900 border-l-4 border-red-500 text-red-300 px-6 py-4 rounded-xl relative mt-4"
                        role="alert">
                        <span id="calendarErrorText" class="font-medium"></span>
                    </div>
                    <button id="viewCalendarBtn"
                        class="w-full bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 mt-2">
                        View Calendar
                    </button>
                </div>
            </div>
        </main>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center my-10 hidden">
            <div class="bg-zinc-900 p-10 rounded-3xl card-shadow flex flex-col items-center">
                <div class="loading-spinner border-4 border-gray-700 border-t-blue-500 rounded-full w-12 h-12 animate-spin"></div>
                <p class="mt-4 text-xl font-medium text-gray-400">Loading Market Data...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage"
            class="hidden my-10 bg-red-900 border-l-4 border-red-500 text-red-300 px-6 py-4 rounded-3xl shadow-md text-center">
            <strong class="font-bold">Oops!</strong>
            <span class="block sm:inline" id="errorText"> An error occurred while loading data. Please try again.</span>
        </div>

        <!-- General News Section -->
        <section id="generalNewsSection" class="w-full hidden">
            <h2 class="text-3xl font-semibold text-gray-200 mb-8 text-center">General Market News</h2>
            <div id="newsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- News articles will be dynamically inserted here -->
            </div>
        </section>

        <!-- Top Gainers, Losers, and Most Active Section -->
        <section id="marketSummarySection" class="w-full grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            <!-- Top Gainers -->
            <div class="bg-zinc-900 p-8 rounded-3xl card-shadow">
                <h3 class="text-2xl font-bold text-green-500 mb-6 text-center">Top Gainers</h3>
                <div class="overflow-x-auto">
                    <table class="w-full market-table">
                        <thead>
                            <tr>
                                <th class="rounded-tl-xl">Stock</th>
                                <th>Price</th>
                                <th class="text-right rounded-tr-xl">Change (%)</th>
                            </tr>
                        </thead>
                        <tbody id="gainersList">
                            <!-- Top gainers will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Losers -->
            <div class="bg-zinc-900 p-8 rounded-3xl card-shadow">
                <h3 class="text-2xl font-bold text-red-500 mb-6 text-center">Top Losers</h3>
                <div class="overflow-x-auto">
                    <table class="w-full market-table">
                        <thead>
                            <tr>
                                <th class="rounded-tl-xl">Stock</th>
                                <th>Price</th>
                                <th class="text-right rounded-tr-xl">Change (%)</th>
                            </tr>
                        </thead>
                        <tbody id="losersList">
                            <!-- Top losers will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Most Active Stocks -->
            <div class="bg-zinc-900 p-8 rounded-3xl card-shadow">
                <h3 class="text-2xl font-bold text-gray-200 mb-6 text-center">Most Active Stocks</h3>
                <div class="overflow-x-auto">
                    <table class="w-full market-table">
                        <thead>
                            <tr>
                                <th class="rounded-tl-xl">Stock</th>
                                <th>Price</th>
                                <th class="text-right rounded-tr-xl">Change (%)</th>
                            </tr>
                        </thead>
                        <tbody id="mostActiveList">
                            <!-- Most active stocks will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBFBOe8Op4jPw4SR6Yla3hs-y4xzqDApoY",
            authDomain: "stocksight-75940.firebaseapp.com",
            projectId: "stocksight-75940",
            storageBucket: "stocksight-75940.firebasestorage.app",
            messagingSenderId: "223645254786",
            appId: "1:223645254786:web:14c980e559d9090f89e09b",
            measurementId: "G-8JGEEE9KD1"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        
        // Check if user is logged in
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Not logged in, redirect to auth page
                //window.location.href = "auth.html";
            }
        });
        
        // Sign out function
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                window.location.href = "auth.html";
            } catch (error) {
                console.error("Error signing out:", error);
            }
        };
    </script>

    <script>
        function goToPricing() {
            window.location.href = "pricing.html";
        }
    </script>
    
    <script>
        // Custom function to show a styled message instead of alert()
        function showMessage(message, type, targetElementId) {
            const messageBox = document.getElementById(targetElementId);
            const messageText = messageBox.querySelector('span');
            messageText.textContent = message;
            messageBox.className = `hidden bg-${type}-900 border-l-4 border-${type}-500 text-${type}-300 px-6 py-4 rounded-xl relative mt-8 transition-all duration-300 transform scale-100`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Set default date for the new calendar input field to today
            const today = new Date();
            document.getElementById('calendarDate').value = today.toISOString().split('T')[0];

            // Stock Search Button Logic
            document.getElementById('searchStockBtn').addEventListener('click', async () => {
                const stockSymbolInput = document.getElementById('stockSymbolInput');
                const symbol = stockSymbolInput.value.trim().toUpperCase();

                if (symbol.length === 0) {
                    showMessage('Please enter a stock symbol.', 'red', 'validationMessage');
                    return;
                }

                const loadingIndicator = document.getElementById('loadingIndicator');
                loadingIndicator.classList.remove('hidden');

                try {
                    const validationApiUrl = `https://stock-backend-0128.onrender.com/check?stock=${symbol}`;
                    let response;
                    let attempts = 0;
                    const maxAttempts = 3;
                    const baseDelay = 1000;

                    while (attempts < maxAttempts) {
                        try {
                            response = await fetch(validationApiUrl);
                            if (response.ok) {
                                break;
                            } else {
                                throw new Error(`HTTP Error: ${response.status}`);
                            }
                        } catch (error) {
                            attempts++;
                            if (attempts < maxAttempts) {
                                const delay = baseDelay * (2 ** attempts);
                                console.error(`Attempt ${attempts} failed. Retrying in ${delay / 1000}s...`, error);
                                await new Promise(res => setTimeout(res, delay));
                            } else {
                                throw error;
                            }
                        }
                    }

                    const data = await response.json();

                    if (data['valid?'] === 1) {
                        window.location.href = `general_info.html?stock=${symbol}`;
                    } else if (data['error']) {
                        showMessage(data['error'], 'red', 'validationMessage');
                    } else {
                        showMessage('Please enter a valid stock symbol.', 'red', 'validationMessage');
                    }
                } catch (error) {
                    console.error("Failed to validate stock symbol:", error);
                    showMessage(
                        'error: please enter a valid stock symbol.',
                        'red',
                        'validationMessage'
                    );
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            });

            // View Calendar Button Logic
            document.getElementById('viewCalendarBtn').addEventListener('click', () => {
                const selectedDate = document.getElementById('calendarDate').value;
                const selectedCalendarTypeFile = document.getElementById('calendarTypeSelect').value;
                const errorMessageDiv = document.getElementById('calendarErrorMessage');
                const errorTextSpan = document.getElementById('calendarErrorText');

                errorMessageDiv.classList.add('hidden');

                if (!selectedDate) {
                    errorTextSpan.textContent = 'Please select a date for the calendar.';
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }

                if (!selectedCalendarTypeFile) {
                    errorTextSpan.textContent = 'Please select a calendar type.';
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }

                window.location.href = `${selectedCalendarTypeFile}?date=${selectedDate}`;
            });

            // =========================================================================
            // CODE FOR DYNAMIC MARKET DATA
            // =========================================================================
            const API_URL = "https://stock-backend-0128.onrender.com/tabzero";
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessageDiv = document.getElementById('errorMessage');
            const errorTextSpan = document.getElementById('errorText');
            const newsContainer = document.getElementById('newsContainer');
            const gainersList = document.getElementById('gainersList');
            const losersList = document.getElementById('losersList');
            const mostActiveList = document.getElementById('mostActiveList');
            const generalNewsSection = document.getElementById('generalNewsSection');
            const marketSummarySection = document.getElementById('marketSummarySection');

            function formatNumber(num, decimals) {
                return parseFloat(num).toFixed(decimals);
            }

            function renderStocks(stockData, containerElement) {
                containerElement.innerHTML = '';
                if (stockData && stockData.length > 0) {
                    stockData.slice(0, 10).forEach(stock => {
                        const changeColor = stock['Change (%)'] >= 0 ? 'text-green-500' : 'text-red-500';
                        const changeSign = stock['Change (%)'] >= 0 ? '+' : '';
                        const stockRowHtml = `
                            <tr class="border-b last:border-b-0 border-gray-700">
                                <td class="px-4 py-3 font-medium text-gray-200 w-1/2">${stock.Stock} <span class="text-xs text-gray-500">(${stock.Exchange})</span></td>
                                <td class="px-4 py-3 text-gray-400 w-1/4">${formatNumber(stock.Price, 2)}</td>
                                <td class="px-4 py-3 text-right font-semibold ${changeColor} w-1/4">${changeSign}${formatNumber(stock['Change (%)'], 2)}%</td>
                            </tr>`;
                        containerElement.innerHTML += stockRowHtml;
                    });
                }
            }

            function renderNews(newsData) {
                newsContainer.innerHTML = '';
                if (newsData && newsData.length > 0) {
                    generalNewsSection.classList.remove('hidden');
                    newsData.forEach(newsItem => {
                        let newsCardHtml;
                        if (newsItem.Image) {
                            // Render with image if available
                            newsCardHtml = `
                                <div class="news-card">
                                    <img src="${newsItem.Image}" alt="News image" onerror="this.onerror=null;this.src='https://placehold.co/400x200/4B5563/D1D5DB?text=Image+Not+Available';" class="w-full h-48 object-cover rounded-xl mb-4">
                                    <h4 class="text-lg font-bold text-gray-200 line-clamp-2 mb-2"><a href="${newsItem.url}" target="_blank" class="hover:underline">${newsItem.Title}</a></h4>
                                    <p class="text-sm text-gray-400 mb-2">${newsItem.Publisher}</p>
                                    <p class="text-sm text-gray-500 mt-auto">${newsItem.Date.split(' ')[0]}</p>
                                </div>
                            `;
                        } else {
                            // Render a smaller card without an image
                            newsCardHtml = `
                                <div class="news-card">
                                    <h4 class="text-lg font-bold text-gray-200 mb-2"><a href="${newsItem.url}" target="_blank" class="hover:underline">${newsItem.Title}</a></h4>
                                    <p class="text-sm text-gray-400 mb-2">${newsItem.Publisher}</p>
                                    <p class="text-sm text-gray-500 mt-auto">${newsItem.Date.split(' ')[0]}</p>
                                </div>
                            `;
                        }
                        newsContainer.innerHTML += newsCardHtml;
                    });
                }
            }

            /**
             * Fetches and displays the market data from the backend.
             */
            async function fetchMarketData() {
                loadingIndicator.classList.remove('hidden');
                errorMessageDiv.classList.add('hidden');
                generalNewsSection.classList.add('hidden');
                marketSummarySection.classList.add('hidden');

                try {
                    let response;
                    let attempts = 0;
                    const maxAttempts = 3;
                    const baseDelay = 1000;

                    // Implement exponential backoff for API calls
                    while (attempts < maxAttempts) {
                        try {
                            response = await fetch(API_URL);
                            if (response.ok) {
                                break;
                            } else {
                                throw new Error(`HTTP Error: ${response.status}`);
                            }
                        } catch (error) {
                            attempts++;
                            if (attempts < maxAttempts) {
                                const delay = baseDelay * (2 ** attempts);
                                console.error(`Attempt ${attempts} failed. Retrying in ${delay / 1000}s...`, error);
                                await new Promise(res => setTimeout(res, delay));
                            } else {
                                throw error;
                            }
                        }
                    }

                    const data = await response.json();

                    if (data['General News'] && data['General News'].length > 0) {
                        renderNews(data['General News']);
                    }
                    if (data['Top Gainers'] && data['Top Gainers'].length > 0) {
                        renderStocks(data['Top Gainers'], gainersList);
                    }
                    if (data['Top Losers'] && data['Top Losers'].length > 0) {
                        renderStocks(data['Top Losers'], losersList);
                    }
                    if (data['Most Active'] && data['Most Active'].length > 0) {
                        renderStocks(data['Most Active'], mostActiveList);
                    }

                    // Show the sections if data was successfully rendered
                    if (data['General News'] && data['General News'].length > 0) {
                        generalNewsSection.classList.remove('hidden');
                    }
                    if (data['Top Gainers'] && data['Top Gainers'].length > 0 ||
                        data['Top Losers'] && data['Top Losers'].length > 0 ||
                        data['Most Active'] && data['Most Active'].length > 0) {
                        marketSummarySection.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Failed to fetch market data:", error);
                    errorTextSpan.textContent = `An error occurred: ${error.message}. Please try again later.`;
                    errorMessageDiv.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }

            // Call the function to fetch data on page load
            fetchMarketData();
        });
    </script>
</body>
</html>
