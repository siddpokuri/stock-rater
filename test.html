<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Info Hub</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom font for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define a custom color palette */
        :root {
            --bg-gray: #f3f4f6;
            --card-bg: #ffffff;
            --blue-accent: #2563eb;
            --green-accent: #10b981;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-gray);
        }

        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .news-card {
            @apply flex flex-col bg-white p-4 rounded-xl card-shadow transition-shadow duration-200 hover:shadow-xl;
        }

        .loading-spinner {
            border-top-color: #2563eb;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start p-4 sm:p-6">

    <!-- Main Container for the entire app -->
    <div class="w-full max-w-6xl mx-auto flex flex-col gap-12">

        <!-- Header Section with a subtle gradient and shadow -->
        <header class="w-full text-center py-8 rounded-2xl bg-gradient-to-r from-gray-50 to-gray-200 card-shadow">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 mb-2">Stock Info Hub</h1>
        </header>

        <!-- Main Content Grid -->
        <main class="w-full grid grid-cols-1 md:grid-cols-2 gap-8">

            <!-- Stock Search Section -->
            <div class="bg-white p-8 rounded-2xl card-shadow flex flex-col items-center text-center">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">Search Stock by Symbol</h2>
                <div class="flex flex-col gap-6 w-full max-w-sm">
                    <input type="text" id="stockSymbolInput" placeholder="e.g., AAPL, GOOG" class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    <button id="searchStockBtn" class="w-full bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105">View Stock Info</button>
                </div>
                <!-- Custom Message Box for validation errors -->
                <div id="validationMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-6 transition-all duration-300 transform scale-95" role="alert">
                    <span id="validationText"></span>
                </div>
            </div>

            <!-- Calendar Selection Section -->
            <div class="bg-white p-8 rounded-2xl card-shadow flex flex-col items-center text-center">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">View Calendar by Date</h2>
                <div class="flex flex-col gap-6 w-full max-w-sm">
                    <div class="flex flex-col text-left">
                        <label for="calendarDate" class="text-gray-700 font-medium mb-1">Select Date:</label>
                        <input type="date" id="calendarDate" class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div class="flex flex-col text-left">
                        <label for="calendarTypeSelect" class="text-gray-700 font-medium mb-1">Select Calendar Type:</label>
                        <select id="calendarTypeSelect" class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                            <option value="earnings_calendar.html">Upcoming/Historical Earnings Calendar</option>
                            <option value="ipos_calendar.html">Upcoming/Historical IPO Calendar</option>
                            <option value="split_calendar.html">Upcoming/Historical Split Calendar</option>
                        </select>
                    </div>

                    <!-- Error Message for Calendar -->
                    <div id="calendarErrorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative mt-4" role="alert">
                        <span id="calendarErrorText"></span>
                    </div>

                    <button id="viewCalendarBtn" class="w-full bg-green-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 mt-2">View Calendar</button>
                </div>
            </div>
        </main>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center my-10 hidden">
            <div class="bg-white p-10 rounded-2xl card-shadow flex flex-col items-center">
                <div class="loading-spinner border-4 border-gray-200 border-t-blue-500 rounded-full w-12 h-12 animate-spin"></div>
                <p class="mt-4 text-xl font-medium text-gray-600">Loading Market Data...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden my-10 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-2xl card-shadow text-center">
            <strong class="font-bold">Oops!</strong>
            <span class="block sm:inline" id="errorText">An error occurred while loading data. Please try again.</span>
        </div>

        <!-- General News Section -->
        <section id="generalNewsSection" class="w-full hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">General Market News</h2>
            <div id="newsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- News articles will be dynamically inserted here -->
            </div>
        </section>

        <!-- Top Gainers, Losers, and Most Active Section -->
        <section id="marketSummarySection" class="w-full grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            <!-- Top Gainers -->
            <div class="bg-white p-8 rounded-2xl card-shadow">
                <h3 class="text-2xl font-bold text-green-600 mb-4 text-center">Top Gainers</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-gray-600 font-semibold rounded-tl-xl w-1/2">Stock</th>
                                <th class="px-4 py-2 text-left text-gray-600 font-semibold w-1/4">Price</th>
                                <th class="px-4 py-2 text-right text-gray-600 font-semibold rounded-tr-xl w-1/4">Change (%)</th>
                            </tr>
                        </thead>
                        <tbody id="gainersList">
                            <!-- Top gainers will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Losers -->
            <div class="bg-white p-8 rounded-2xl card-shadow">
                <h3 class="text-2xl font-bold text-red-600 mb-4 text-center">Top Losers</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-gray-600 font-semibold rounded-tl-xl w-1/2">Stock</th>
                                <th class="px-4 py-2 text-left text-gray-600 font-semibold w-1/4">Price</th>
                                <th class="px-4 py-2 text-right text-gray-600 font-semibold rounded-tr-xl w-1/4">Change (%)</th>
                            </tr>
                        </thead>
                        <tbody id="losersList">
                            <!-- Top losers will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Most Active Stocks -->
            <div class="bg-white p-8 rounded-2xl card-shadow">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Most Active Stocks</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-gray-600 font-semibold rounded-tl-xl w-1/2">Stock</th>
                                <th class="px-4 py-2 text-left text-gray-600 font-semibold w-1/4">Price</th>
                                <th class="px-4 py-2 text-right text-gray-600 font-semibold rounded-tr-xl w-1/4">Change (%)</th>
                            </tr>
                        </thead>
                        <tbody id="mostActiveList">
                            <!-- Most active stocks will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </div>

    <script>
        // Custom function to show a styled message instead of alert()
        function showMessage(message, type, targetElementId) {
            const messageBox = document.getElementById(targetElementId);
            const messageText = messageBox.querySelector('span');

            messageText.textContent = message;
            messageBox.className = `bg-${type}-100 border border-${type}-400 text-${type}-700 px-4 py-3 rounded-xl relative mt-6 transition-all duration-300 transform scale-100`;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Set default date for the new calendar input field to today
            const today = new Date();
            document.getElementById('calendarDate').value = today.toISOString().split('T')[0];

            // Stock Search Button Logic
            // The logic has been updated to include an async fetch call for validation.
            document.getElementById('searchStockBtn').addEventListener('click', async () => {
                const stockSymbolInput = document.getElementById('stockSymbolInput');
                const symbol = stockSymbolInput.value.trim().toUpperCase();

                // Validation check for empty input
                if (symbol.length === 0) {
                    showMessage('Please enter a stock symbol.', 'red', 'validationMessage');
                    return;
                }

                // Show loading indicator while waiting for validation
                const loadingIndicator = document.getElementById('loadingIndicator');
                loadingIndicator.classList.remove('hidden');

                try {
                    // Endpoint for stock validation
                    const validationApiUrl = `https://stock-backend-0128.onrender.com/check?stock=${symbol}`;

                    let response;
                    let attempts = 0;
                    const maxAttempts = 3;
                    const baseDelay = 1000;

                    // Implement exponential backoff for API calls
                    while (attempts < maxAttempts) {
                        try {
                            response = await fetch(validationApiUrl);
                            if (response.ok) {
                                break;
                            } else {
                                throw new Error(`HTTP Error: ${response.status}`);
                            }
                        } catch (error) {
                            attempts++;
                            if (attempts < maxAttempts) {
                                const delay = baseDelay * (2 ** attempts);
                                console.error(`Attempt ${attempts} failed. Retrying in ${delay / 1000}s...`, error);
                                await new Promise(res => setTimeout(res, delay));
                            } else {
                                throw error;
                            }
                        }
                    }

                    const data = await response.json();

                    // Check the API response for validity
                    if (data['valid?'] === 1) {
                        // If valid, navigate to the stock info page
                        window.location.href = `general_info.html?stock=${symbol}`;
                    } else if (data['error']) {
                        // If there's an error message, display it
                        showMessage(data['error'], 'red', 'validationMessage');
                    } else {
                        // Handle unexpected response
                        showMessage('Could not validate stock symbol. Please try again.', 'red', 'validationMessage');
                    }
                } catch (error) {
                    console.error("Failed to validate stock symbol:", error);
                    showMessage('Network error: Could not connect to validation service. Please check your connection and try again.', 'red', 'validationMessage');
                    } finally {
                    // Hide loading indicator after the request is complete
                    loadingIndicator.classList.add('hidden');
                }
            });

            // View Calendar Button Logic
            document.getElementById('viewCalendarBtn').addEventListener('click', () => {
                const selectedDate = document.getElementById('calendarDate').value;
                const selectedCalendarTypeFile = document.getElementById('calendarTypeSelect').value;
                const errorMessageDiv = document.getElementById('calendarErrorMessage');
                const errorTextSpan = document.getElementById('calendarErrorText');

                errorMessageDiv.classList.add('hidden'); // Hide previous errors

                if (!selectedDate) {
                    errorTextSpan.textContent = 'Please select a date for the calendar.';
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }

                if (!selectedCalendarTypeFile) {
                    errorTextSpan.textContent = 'Please select a calendar type.';
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }

                // Navigate to the selected calendar page, passing the date as a query parameter
                window.location.href = `${selectedCalendarTypeFile}?date=${selectedDate}`;
            });

            // =========================================================================
            // CODE FOR DYNAMIC MARKET DATA
            // =========================================================================

            const API_URL = "https://stock-backend-0128.onrender.com/tabzero";

            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessageDiv = document.getElementById('errorMessage');
            const errorTextSpan = document.getElementById('errorText');
            const newsContainer = document.getElementById('newsContainer');
            const gainersList = document.getElementById('gainersList');
            const losersList = document.getElementById('losersList');
            const mostActiveList = document.getElementById('mostActiveList');
            const generalNewsSection = document.getElementById('generalNewsSection');
            // Changed section id to be more general since it now contains three tables
            const marketSummarySection = document.getElementById('marketSummarySection'); 

            /**
             * Formats a number to a specified number of decimal places.
             * @param {number} num The number to format.
             * @param {number} decimals The number of decimal places.
             * @returns {string} The formatted number as a string.
             */
            function formatNumber(num, decimals) {
                return parseFloat(num).toFixed(decimals);
            }

            /**
             * Renders a list of stocks (gainers, losers, or most active) into a table.
             * @param {Array} stockData An array of stock objects.
             * @param {HTMLElement} containerElement The element to render the list into.
             */
            function renderStocks(stockData, containerElement) {
                containerElement.innerHTML = ''; // Clear previous content
                if (stockData && stockData.length > 0) {
                    stockData.slice(0, 10).forEach(stock => {
                        const changeColor = stock['Change (%)'] >= 0 ? 'text-green-600' : 'text-red-600';
                        const changeSign = stock['Change (%)'] >= 0 ? '+' : '';
                        const stockRowHtml = `
                            <tr class="border-b last:border-b-0 border-gray-200 hover:bg-gray-50 transition-colors duration-150">
                                <td class="px-4 py-3 font-medium text-gray-800 w-1/2">${stock.Stock} <span class="text-xs text-gray-400">(${stock.Exchange})</span></td>
                                <td class="px-4 py-3 text-gray-700 w-1/4">${formatNumber(stock.Price, 2)}</td>
                                <td class="px-4 py-3 text-right font-semibold ${changeColor} w-1/4">${changeSign}${formatNumber(stock['Change (%)'], 2)}%</td>
                            </tr>
                        `;
                        containerElement.innerHTML += stockRowHtml;
                    });
                }
            }

            /**
             * Renders the general market news cards.
             * @param {Array} newsData An array of news objects.
             */
            function renderNews(newsData) {
                newsContainer.innerHTML = ''; // Clear previous content
                if (newsData && newsData.length > 0) {
                    generalNewsSection.classList.remove('hidden');
                    newsData.forEach(newsItem => {
                        const newsCardHtml = `
                            <div class="news-card">
                                <img src="${newsItem.Image}" alt="News image" onerror="this.onerror=null;this.src='https://placehold.co/400x200/e5e7eb/4b5563?text=Image+Not+Available';" class="w-full h-48 object-cover rounded-xl mb-4">
                                <h4 class="text-lg font-bold text-gray-800 line-clamp-2 mb-2"><a href="${newsItem.url}" target="_blank" class="hover:underline">${newsItem.Title}</a></h4>
                                <p class="text-sm text-gray-500 mb-2">${newsItem.Publisher}</p>
                                <p class="text-sm text-gray-400 mt-auto">${newsItem.Date.split(' ')[0]}</p>
                            </div>
                        `;
                        newsContainer.innerHTML += newsCardHtml;
                    });
                }
            }


            /**
             * Fetches and displays the market data from the backend.
             */
            async function fetchMarketData() {
                loadingIndicator.classList.remove('hidden');
                errorMessageDiv.classList.add('hidden');
                generalNewsSection.classList.add('hidden');
                marketSummarySection.classList.add('hidden');

                try {
                    let response;
                    let attempts = 0;
                    const maxAttempts = 3;
                    const baseDelay = 1000;

                    // Implement exponential backoff for API calls
                    while (attempts < maxAttempts) {
                        try {
                            response = await fetch(API_URL);
                            if (response.ok) {
                                break;
                            } else {
                                throw new Error(`HTTP Error: ${response.status}`);
                            }
                        } catch (error) {
                            attempts++;
                            if (attempts < maxAttempts) {
                                const delay = baseDelay * (2 ** attempts);
                                console.error(`Attempt ${attempts} failed. Retrying in ${delay / 1000}s...`, error);
                                await new Promise(res => setTimeout(res, delay));
                            } else {
                                throw error;
                            }
                        }
                    }

                    const data = await response.json();

                    if (data['General News'] && data['General News'].length > 0) {
                        renderNews(data['General News']);
                    }
                    if (data['Top Gainers'] && data['Top Gainers'].length > 0) {
                        renderStocks(data['Top Gainers'], gainersList);
                    }
                    if (data['Top Losers'] && data['Top Losers'].length > 0) {
                        renderStocks(data['Top Losers'], losersList);
                    }
                    if (data['Most Active'] && data['Most Active'].length > 0) {
                        renderStocks(data['Most Active'], mostActiveList);
                    }


                    // Show the sections if data was successfully rendered
                    if (data['General News'] && data['General News'].length > 0) {
                        generalNewsSection.classList.remove('hidden');
                    }
                    if (data['Top Gainers'] && data['Top Gainers'].length > 0 || 
                        data['Top Losers'] && data['Top Losers'].length > 0 || 
                        data['Most Active'] && data['Most Active'].length > 0) {
                        marketSummarySection.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Failed to fetch market data:", error);
                    errorTextSpan.textContent = `An error occurred: ${error.message}. Please try again later.`;
                    errorMessageDiv.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }

            // Call the function to fetch data on page load
            fetchMarketData();

        });
    </script>
</body>
</html>
