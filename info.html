<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Info</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom font for a more professional look */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Custom scrollbar for data tables */
    .data-table-container::-webkit-scrollbar {
      height: 8px;
    }
    .data-table-container::-webkit-scrollbar-track {
      background: #374151; /* gray-700 */
      border-radius: 10px;
    }
    .data-table-container::-webkit-scrollbar-thumb {
      background: #6b7280; /* gray-500 */
      border-radius: 10px;
    }
    .data-table-container::-webkit-scrollbar-thumb:hover {
      background: #9ca3af; /* gray-400 */
    }

    /* Specific styles for sticky table headers/cells */
    .sticky-col-header {
        position: sticky;
        left: 0;
        z-index: 20; /* Higher than other cells */
        background-color: #374151; /* gray-700 */
        border-right: 1px solid #4b5563; /* gray-600 */
        box-shadow: 2px 0 5px rgba(0,0,0,0.2); /* Subtle shadow for depth */
    }
    .sticky-row-header {
        position: sticky;
        left: 0;
        z-index: 10; /* Lower than corner, higher than data cells */
        background-color: #374151; /* gray-700 */
        border-right: 1px solid #4b5563; /* gray-600 */
        text-align: left; /* Ensure metric names are left-aligned */
        box-shadow: 2px 0 5px rgba(0,0,0,0.2); /* Subtle shadow for depth */
    }

    /* Styling for individual data cells in the quarterly table */
    .quarterly-data-cell {
        background-color: #1f2937; /* gray-900 for cells */
        border: 1px solid #374151; /* gray-700 for cell borders on all sides */
        padding: 0.75rem 1rem; /* py-3 px-4 */
        text-align: center;
        font-size: 0.875rem; /* text-sm */
        color: #d1d5db; /* gray-300 */
        white-space: nowrap;
        /* Optional: for better numerical alignment if numbers vary in length */
        font-variant-numeric: tabular-nums; 
    }
    /* Ensure no double borders where sticky header meets cells */
    .sticky-row-header + .quarterly-data-cell {
        border-left: none; /* Remove left border from first data cell to avoid double border with sticky header */
    }

    /* D3 Chart Specific Styles */
    .axis path,
    .axis line {
      fill: none;
      stroke: #6b7280; /* gray-500 */
      shape-rendering: crispEdges;
    }
    .axis text {
      font-size: 0.875rem; /* text-sm */
      fill: #9ca3af; /* gray-400 */
    }
    .chart-line { /* Renamed from .line to avoid conflict */
      fill: none;
      stroke-width: 4px; 
    }
    .chart-area { /* Renamed from .area to avoid conflict */
      stroke-width: 0; 
    }
    .overlay {
      fill: none;
      pointer-events: all;
    }
    .focus circle {
      fill: #6366f1; /* indigo-500 */
      stroke: #a5b4fc; /* indigo-300 */
      stroke-width: 2px;
    }
    .tooltip {
      position: absolute;
      text-align: center;
      padding: 8px;
      font: 12px sans-serif;
      background: #374151; /* gray-700 */
      border: 0px;
      border-radius: 4px;
      pointer-events: none;
      color: #d1d5db; /* gray-300 */
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Tab button styles */
    .tab-btn {
      @apply px-4 py-2 rounded-lg font-semibold text-sm md:text-base transition-colors duration-200;
    }
    .active-tab-btn {
      @apply bg-indigo-700 text-white shadow-md;
    }
    .inactive-tab-btn {
      @apply bg-gray-700 text-gray-300 hover:bg-gray-600;
    }

    /* Rating colors */
    .rating-A { @apply text-green-400; }
    .rating-B { @apply text-blue-400; }
    .rating-C { @apply text-yellow-400; }
    .rating-D, .rating-F { @apply text-red-400; }
    .rating-NA { @apply text-gray-400; } /* For N/A or undefined ratings */

    /* Bar chart specific styles */
    .bar {
      fill: #6366f1; /* Default bar color (indigo-500) */
    }
    .bar-positive {
      fill: #10b981; /* green-500 */
    }
    .bar-negative {
      fill: #ef4444; /* red-500 */
    }
  </style>
  <!-- Google Fonts - Inter (for a clean, modern look) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <!-- D3.js CDN for charting -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="min-h-screen bg-gray-900 flex flex-col items-center p-4 font-inter text-gray-300">

  <!-- Stock Header -->
  <div class="w-full max-w-5xl flex flex-col items-center mb-6">
    <h1 id="stockNameHeader" class="text-5xl md:text-6xl lg:text-7xl font-extrabold text-gray-100 text-center leading-tight mb-2">
      Loading Stock...
    </h1>
    <p id="stockSymbolHeader" class="text-2xl md:text-3xl font-semibold text-gray-400 mb-6">
      Loading...
    </p>
  </div>

  <!-- Main Content Card -->
  <div class="w-full max-w-5xl bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 border border-gray-700 flex flex-col items-center space-y-6">
    
    <!-- Tab Navigation -->
    <div class="flex flex-wrap justify-center gap-2 md:gap-4 w-full mb-6 border-b border-gray-700 pb-4">
      <button id="tabGeneral" class="tab-btn active-tab-btn">General</button>
      <button id="tabIncomeStatement" class="tab-btn inactive-tab-btn">Income Statement Info</button>
      <button id="tabBalanceSheet" class="tab-btn inactive-tab-btn">Balance Sheet Info</button>
      <button id="tabRating" class="tab-btn inactive-tab-btn">Rating</button>
      <button id="tabEarnings" class="tab-btn inactive-tab-btn">Earnings Data</button>
      <button id="tabInsiderTrades" class="tab-btn inactive-tab-btn">Latest Insider Trades</button>
      <button id="tabPriceTargets" class="tab-btn inactive-tab-btn">Analyst Price Targets</button>
    </div>

    <!-- Tab Content Areas -->
    <div id="generalContent" class="tab-content w-full">
      <!-- Content for General Tab will be loaded here by JS -->
      <p class="text-gray-400 text-center">Loading General Info...</p>
    </div>

    <div id="incomeStatementContent" class="tab-content w-full hidden">
      <!-- Content for Income Statement Info Tab will be loaded here by JS -->
      <p class="text-gray-400 text-center">Loading Income Statement Info...</p>
    </div>

    <div id="balanceSheetContent" class="tab-content w-full hidden">
      <!-- Content for Balance Sheet Info Tab will be loaded here by JS -->
      <p class="text-gray-400 text-center">Loading Balance Sheet Info...</p>
    </div>

    <div id="ratingContent" class="tab-content w-full hidden">
      <!-- Content for Rating Tab will be loaded here by JS -->
      <p class="text-gray-400 text-center">Loading Rating Info...</p>
    </div>

    <div id="earningsContent" class="tab-content w-full hidden">
      <!-- Content for Earnings Data Tab will be loaded here by JS -->
      <p class="text-gray-400 text-center">Loading Earnings Data...</p>
    </div>

    <div id="insiderTradesContent" class="tab-content w-full hidden">
      <!-- Content for Latest Insider Trades Tab will be loaded here by JS -->
      <p class="text-gray-400 text-center">Loading Insider Trades...</p>
    </div>

    <div id="priceTargetsContent" class="tab-content w-full hidden">
      <!-- Content for Analyst Price Targets Tab will be loaded here by JS -->
      <p class="text-gray-400 text-center">Loading Price Targets...</p>
    </div>

    <!-- Back Button -->
    <button id="backbutton" onclick="goback()"
      class="bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-lg">
      Back to Home
    </button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const stock = params.get("stock");
    const stockNameHeader = document.getElementById("stockNameHeader");
    const stockSymbolHeader = document.getElementById("stockSymbolHeader");

    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    let allStockData = null; // This will hold all the fetched data
    let activeTabId = 'generalContent'; // Default active tab

    // Function to switch tabs
    function showTab(tabId) {
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(tabId).classList.remove('hidden');

      tabButtons.forEach(button => {
        if (button.id === `tab${tabId.replace('Content', '')}`) {
          button.classList.remove('inactive-tab-btn');
          button.classList.add('active-tab-btn');
        } else {
          button.classList.remove('active-tab-btn');
          button.classList.add('inactive-tab-btn');
        }
      });
      activeTabId = tabId; // Update active tab
      renderActiveTabContent(); // Re-render content for the newly active tab
    }

    // Add event listeners to tab buttons
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        showTab(`${button.id.replace('tab', '')}Content`);
      });
    });

    // Function to render content based on the active tab and fetched data
    function renderActiveTabContent() {
      if (!allStockData) {
        // Data not yet loaded, keep showing loading messages
        return;
      }

      // Clear current tab content (except for the chart container, which D3 handles)
      const currentContentDiv = document.getElementById(activeTabId);
      if (activeTabId !== 'generalContent') { // Chart rendering is more complex, handled separately
         currentContentDiv.innerHTML = ''; 
      }


      // Render content based on activeTabId
      switch (activeTabId) {
        case 'generalContent':
          renderGeneralTab(allStockData["Tab 1"]);
          break;
        case 'incomeStatementContent':
          renderIncomeStatementTab(allStockData["Tab 2"]);
          break;
        case 'balanceSheetContent':
          renderBalanceSheetTab(allStockData["Tab 3"]);
          break;
        case 'ratingContent':
          renderRatingTab(allStockData["Tab 4"]);
          break;
        case 'earningsContent':
          renderEarningsTab(allStockData["Tab 5"]);
          break;
        case 'insiderTradesContent':
          renderInsiderTradesTab(allStockData["Tab 6"]);
          break;
        case 'priceTargetsContent':
          renderPriceTargetsTab(allStockData["Tab 7"]);
          break;
        default:
          break;
      }
    }

    // --- Tab 1: General Info and Chart ---
    let currentChartPeriod = '1D'; // Keep track of the active chart period

    function calculatePercentageChange(data) {
      if (!data || data.length < 2) return null;
      const firstPrice = +data[0].close || +data[0].price;
      const lastPrice = +data[data.length - 1].close || +data[data.length - 1].price;
      if (isNaN(firstPrice) || isNaN(lastPrice) || firstPrice === 0) return null;
      return ((lastPrice - firstPrice) / firstPrice) * 100;
    }

    function renderChart(chartData, period) {
      const chartContainer = document.getElementById('chartContainer');
      chartContainer.innerHTML = ''; // Clear previous chart

      if (!chartData || chartData === 'N/A' || chartData.length === 0) {
        chartContainer.innerHTML = `<p class="text-gray-400">No ${period} chart data available.</p>`;
        document.getElementById('chartPercentageChange').textContent = `Change: N/A`;
        document.getElementById('chartVolume').textContent = `Volume: N/A`;
        return;
      }

      // Update Percentage Change Display
      const pChange = calculatePercentageChange(chartData);
      let lineColor, areaColor;
      const threshold = 0.01;

      if (pChange !== null) {
        const pChangeText = pChange.toFixed(2);
        document.getElementById('chartPercentageChange').textContent = `Change: ${pChangeText}%`;
        if (pChange > threshold) {
          lineColor = '#059669'; // Tailwind green-600 (darker green)
          areaColor = '#10b981'; // Tailwind green-500 (lighter green)
          document.getElementById('chartPercentageChange').className = `text-xl md:text-2xl font-semibold text-green-400`;
        } else if (pChange < -threshold) {
          lineColor = '#dc2626'; // Tailwind red-600 (darker red)
          areaColor = '#ef4444'; // Tailwind red-500 (lighter red)
          document.getElementById('chartPercentageChange').className = `text-xl md:text-2xl font-semibold text-red-400`;
        } else {
          lineColor = '#6b7280'; // Tailwind gray-500 (darker gray)
          areaColor = '#9ca3af'; // Tailwind gray-400 (lighter gray)
          document.getElementById('chartPercentageChange').className = `text-xl md:text-2xl font-semibold text-gray-400`;
        }
      } else {
        lineColor = '#6366f1'; // Default Indigo if percentage change cannot be calculated
        areaColor = '#6366f1';
        document.getElementById('chartPercentageChange').textContent = `Change: N/A`;
        document.getElementById('chartPercentageChange').className = `text-xl md:text-2xl font-semibold text-gray-200`;
      }

      // Update Volume Display (only for 1D)
      if (period === '1D' && allStockData["Tab 1"]["Volume (last trading day)"] !== 'N/A') {
        document.getElementById('chartVolume').textContent = `Volume: ${allStockData["Tab 1"]["Volume (last trading day)"]}`;
        document.getElementById('chartVolume').classList.remove('hidden');
      } else {
        document.getElementById('chartVolume').textContent = `Volume: N/A`;
        document.getElementById('chartVolume').classList.add('hidden'); // Hide for other periods
      }

      const margin = { top: 20, right: 30, bottom: 40, left: 60 };
      const width = chartContainer.clientWidth - margin.left - margin.right;
      const height = chartContainer.clientHeight - margin.top - margin.bottom;

      const svg = d3.select("#chartContainer")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // Prepare data: Ensure 'date' and 'value' properties are consistent
      const filteredData = chartData.filter(d => {
        d.displayDate = d.datetime || d.date; // Use original string for X-axis domain
        d.parsedDate = period.includes('D') ? d3.timeParse("%Y-%m-%d %H:%M:%S")(d.displayDate) : d3.timeParse("%Y-%m-%d")(d.displayDate);
        d.value = +d.close || +d.price;
        return d.parsedDate && !isNaN(d.value);
      });

      if (filteredData.length === 0) {
        chartContainer.innerHTML = `<p class="text-gray-400">No valid ${period} data to display.</p>`;
        return;
      }

      // Set up scales
      const x = d3.scalePoint()
        .domain(filteredData.map(d => d.displayDate))
        .range([0, width])
        .padding(0.5);

      const y = d3.scaleLinear()
        .domain(d3.extent(filteredData, d => d.value))
        .nice()
        .range([height, 0]);

      // Add X axis
      svg.append("g")
        .attr("class", "x axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x)
          .tickValues(x.domain().filter((d, i) => {
            const interval = Math.ceil(filteredData.length / 7); 
            return i % interval === 0;
          }))
          .tickFormat(d => {
            const dateObj = period.includes('D') ? d3.timeParse("%Y-%m-%d %H:%M:%S")(d) : d3.timeParse("%Y-%m-%d")(d);
            if (!dateObj) return '';
            return period.includes('D') ? d3.timeFormat("%H:%M")(dateObj) : d3.timeFormat("%b %d")(dateObj);
          })
        )
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");

      // Add Y axis
      svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(y).ticks(5));

      // Add the area path (solid fill)
      const area = d3.area()
        .x(d => x(d.displayDate))
        .y0(height)
        .y1(d => y(d.value));

      svg.append("path")
        .datum(filteredData)
        .attr("class", "chart-area")
        .attr("fill", areaColor)
        .attr("d", area);

      // Add the line path
      const line = d3.line()
        .x(d => x(d.displayDate))
        .y(d => y(d.value));

      svg.append("path")
        .datum(filteredData)
        .attr("class", "chart-line")
        .attr("stroke", lineColor);

      // Add tooltip functionality
      const focus = svg.append("g")
        .attr("class", "focus")
        .style("display", "none");

      focus.append("circle")
        .attr("r", 5);

      const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      svg.append("rect")
        .attr("class", "overlay")
        .attr("width", width)
        .attr("height", height)
        .on("mouseover", () => { focus.style("display", null); tooltip.style("opacity", 1); })
        .on("mouseout", () => { focus.style("display", "none"); tooltip.style("opacity", 0); })
        .on("mousemove", mousemove);

      function mousemove(event) {
        const xPos = d3.pointer(event)[0];
        const closestIndex = d3.leastIndex(filteredData, d => Math.abs(x(d.displayDate) - xPos));
        const d = filteredData[closestIndex];

        if (d) {
          focus.attr("transform", `translate(${x(d.displayDate)},${y(d.value)})`);
          const tooltipDate = period.includes('D') ? d3.timeFormat("%Y-%m-%d %H:%M")(d.parsedDate) : d3.timeFormat("%Y-%m-%d")(d.parsedDate);
          tooltip.html(`Date: ${tooltipDate}<br>Price: ${d.value.toFixed(2)}`)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 28) + "px");
        }
      }
    }

    function renderGeneralTab(data) {
      const contentDiv = document.getElementById('generalContent');
      contentDiv.innerHTML = ''; // Clear existing content

      if (!data || data === 'N/A' || data.error) {
        contentDiv.innerHTML = `<p class="text-red-400 text-center">No General data available for ${stock}.</p>`;
        return;
      }

      // Update header with actual company name and symbol
      if (data["Profile Info"] && data["Profile Info"]["Company Name"] && data["Profile Info"]["Sector"]) {
        stockNameHeader.textContent = data["Profile Info"]["Company Name"];
        // Using 'Sector' from Profile Info as 'exchange' for display purposes, as direct 'exchange' wasn't in JSON
        stockSymbolHeader.textContent = `(${data["Profile Info"]["Sector"] || 'N/A'}: ${stock})`; 
      } else {
        stockNameHeader.textContent = `${stock} - General Info`;
        stockSymbolHeader.textContent = `(Symbol: ${stock})`;
      }

      // Recreate structure for generalContent
      contentDiv.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
          <!-- Chart Section -->
          <div class="chart-section bg-gray-700 rounded-lg p-4 flex flex-col items-center">
            <div class="flex flex-wrap justify-center gap-2 w-full mb-4">
              <button id="chartBtn1D" class="chart-period-btn bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
                1 Day
              </button>
              <button id="chartBtn5D" class="chart-period-btn bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
                5 Day
              </button>
              <button id="chartBtn1M" class="chart-period-btn bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
                1 Month
              </button>
              <button id="chartBtn1Y" class="chart-period-btn bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
                1 Year
              </button>
            </div>
            <div id="chartContainer" class="w-full h-80 bg-gray-800 rounded-lg flex items-center justify-center text-gray-400 text-lg mb-4">
              Loading chart data...
            </div>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 w-full">
              <div id="chartPercentageChange" class="text-xl md:text-2xl font-semibold text-gray-200">
                Change: Loading...
              </div>
              <div id="chartVolume" class="text-xl md:text-2xl font-semibold text-gray-200">
                Volume: Loading...
              </div>
            </div>
          </div>

          <!-- General Info Box -->
          <div class="general-info-box bg-gray-700 rounded-lg p-4 flex flex-col space-y-3">
            <h3 class="text-2xl font-bold text-gray-100 mb-2">Company Overview</h3>
            <div id="generalInfoDetails" class="divide-y divide-gray-600">
              <!-- Details will be populated here by JS -->
            </div>
          </div>
        </div>
      `;

      // Populate General Info Details
      const generalInfoDetailsDiv = document.getElementById('generalInfoDetails');
      const profile = data["Profile Info"] || {};

      const infoItems = [
        { label: "Industry", value: profile["Industry"] || "N/A" },
        { label: "Sector", value: profile["Sector"] || "N/A" },
        { label: "Market Cap", value: profile["Market Cap"] || "N/A" },
        { label: "Country", value: profile["Country"] || "N/A" }, 
        { label: "Volume (Last Day)", value: data["Volume (last trading day)"] || "N/A" },
        { label: "Beta", value: profile["Beta"] || "N/A" },
        { label: "EPS", value: data["EPS"] || "N/A" },
        { label: "P/E Ratio", value: data["PE Ratio"] || "N/A" },
        { label: "Quarterly Dividend", value: data["Quarterly Dividend"] || "N/A" }
      ];

      generalInfoDetailsDiv.innerHTML = infoItems.map(item => `
        <p class="py-2 flex justify-between">
          <strong class="text-gray-200">${item.label}:</strong> 
          <span class="text-gray-300">${item.value}</span>
        </p>
      `).join('');

      // Add event listeners for chart period buttons
      document.getElementById('chartBtn1D').addEventListener('click', () => {
        currentChartPeriod = '1D';
        renderChart(data["1D"], '1D');
        setActiveChartButton('chartBtn1D');
      });
      document.getElementById('chartBtn5D').addEventListener('click', () => {
        currentChartPeriod = '5D';
        renderChart(data["5D"], '5D');
        setActiveChartButton('chartBtn5D');
      });
      document.getElementById('chartBtn1M').addEventListener('click', () => {
        currentChartPeriod = '1M';
        renderChart(data["1M"], '1M');
        setActiveChartButton('chartBtn1M');
      });
      document.getElementById('chartBtn1Y').addEventListener('click', () => {
        currentChartPeriod = '1Y';
        renderChart(data["1Y"], '1Y');
        setActiveChartButton('chartBtn1Y');
      });

      // Initial chart render (default to 1D)
      renderChart(data["1D"], '1D');
      setActiveChartButton('chartBtn1D');

      // Handle window resize for chart responsiveness
      window.removeEventListener('resize', resizeChartHandler); // Remove old listener
      window.addEventListener('resize', resizeChartHandler); // Add new listener
    }

    // Helper to set active chart button style
    function setActiveChartButton(activeBtnId) {
      document.querySelectorAll('.chart-period-btn').forEach(button => {
        if (button.id === activeBtnId) {
          button.classList.remove('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
          button.classList.add('bg-indigo-700', 'text-white', 'hover:bg-indigo-800');
        } else {
          button.classList.remove('bg-indigo-700', 'text-white', 'hover:bg-indigo-800');
          button.classList.add('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
        }
      });
    }

    // Resize handler for the chart
    let resizeChartHandler = () => {
      if (activeTabId === 'generalContent' && allStockData && allStockData["Tab 1"]) {
        renderChart(allStockData["Tab 1"][currentChartPeriod], currentChartPeriod);
      }
    };

    // --- Helper function to render tables (used by Income Statement and Balance Sheet) ---
    function renderTable(containerId, data, periodType, metricsConfig) {
      const container = document.getElementById(containerId);
      container.innerHTML = ''; // Clear previous content

      if (!data || data === 'N/A' || data.error) {
        container.innerHTML = `<p class="text-gray-400 text-center">No ${periodType} data available.</p>`;
        return;
      }

      // Determine if it's quarterly data by checking for 'dates' key
      const isQuarterly = data.dates && Array.isArray(data.dates) && data.dates.length > 0;

      if (isQuarterly) {
        const dates = data.dates;
        const metrics = metricsConfig.filter(m => data[m.key] && Array.isArray(data[m.key])); // Filter to only include metrics with array data

        const tableContainer = document.createElement('div');
        tableContainer.className = 'data-table-container w-full overflow-x-auto rounded-lg border border-gray-700 shadow-lg';

        const table = document.createElement('table');
        table.className = 'min-w-full'; 

        // Table Header (Dates)
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.className = 'bg-gray-700 border-b border-gray-600'; 

        const cornerTh = document.createElement('th');
        cornerTh.className = 'py-3 px-4 text-left text-sm font-medium text-gray-300 uppercase tracking-wider sticky-col-header';
        cornerTh.textContent = 'Metric';
        headerRow.appendChild(cornerTh);

        dates.forEach(date => {
          const th = document.createElement('th');
          th.className = 'py-3 px-4 text-center text-sm font-medium text-gray-300 uppercase tracking-wider min-w-[100px] border-l border-gray-600'; 
          th.textContent = date;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Table Body (Metrics and Values)
        const tbody = document.createElement('tbody');
        
        metrics.forEach(metric => {
          const row = document.createElement('tr');
          row.className = 'odd:bg-gray-800 even:bg-gray-700 hover:bg-gray-600 transition-colors duration-200 border-b border-gray-700'; 

          const metricTh = document.createElement('th');
          metricTh.className = 'py-3 px-4 text-sm font-medium text-gray-200 sticky-row-header whitespace-nowrap';
          metricTh.textContent = metric.label;
          row.appendChild(metricTh);

          const values = data[metric.key]; 
          dates.forEach((date, index) => {
            const td = document.createElement('td');
            td.className = 'quarterly-data-cell'; 
            td.textContent = values[index] !== undefined ? values[index] : 'N/A'; 
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        tableContainer.appendChild(table);
        container.appendChild(tableContainer);

      } else {
        // Render as simple key-value pairs for Yearly data
        const dataContainer = document.createElement('div');
        dataContainer.className = 'w-full divide-y divide-gray-700 rounded-lg border border-gray-700 overflow-hidden';

        metricsConfig.forEach(metric => {
          const value = data[metric.key];
          if (value !== undefined && value !== null) { // Only render if value exists
            const item = document.createElement('div');
            item.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center py-3 px-4 bg-gray-700 hover:bg-gray-600 transition-colors duration-200';
            const keyElement = document.createElement('strong');
            keyElement.className = 'text-gray-200 text-lg sm:text-xl mb-1 sm:mb-0';
            keyElement.textContent = `${metric.label}:`;
            const valueElement = document.createElement('span');
            valueElement.className = 'text-gray-300 text-lg sm:text-xl text-right';
            valueElement.textContent = value;
            item.appendChild(keyElement);
            item.appendChild(valueElement);
            dataContainer.appendChild(item);
          }
        });
        if (dataContainer.children.length > 0) { // Only append if content was added
            container.appendChild(dataContainer);
        } else {
            container.innerHTML = `<p class="text-gray-400 text-center">No ${periodType} data available.</p>`;
        }
      }
    }

    // --- Tab 2: Income Statement Info ---
    let currentIncomeStatementPeriod = 'Yearly'; // Default for Income Statement
    function renderIncomeStatementTab(data) {
      const contentDiv = document.getElementById('incomeStatementContent');
      contentDiv.innerHTML = ''; // Clear existing content

      if (!data || data === 'N/A' || data.error) {
        contentDiv.innerHTML = `<p class="text-red-400 text-center">No Income Statement data available for ${stock}.</p>`;
        return;
      }

      // Create structure for Income Statement tab
      contentDiv.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
          <!-- Table Section -->
          <div class="income-statement-table-section bg-gray-700 rounded-lg p-4 flex flex-col items-center">
            <div class="flex flex-wrap justify-center gap-2 w-full mb-4">
              <button id="incomeBtnYearly" class="period-btn bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
                Yearly
              </button>
              <button id="incomeBtnQuarterly" class="period-btn bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
                Quarterly
              </button>
            </div>
            <div id="incomeTableContainer" class="w-full">
              <!-- Income Statement Table will be rendered here -->
            </div>
          </div>

          <!-- Bar Chart Section -->
          <div class="income-statement-chart-section bg-gray-700 rounded-lg p-4 flex flex-col items-center">
            <h3 class="text-xl font-bold text-gray-100 mb-4">Revenue Over Time</h3>
            <div id="revenueBarChart" class="w-full h-80 bg-gray-800 rounded-lg flex items-center justify-center text-gray-400 text-lg">
              Loading chart...
            </div>
          </div>
        </div>
      `;

      // Define metrics for Income Statement table
      const incomeMetricsConfig = [
        { label: "Revenue", key: "Revenue" },
        { label: "Gross Profit", key: "Gross Profit" },
        { label: "Net Income", key: "Net Income" },
        { label: "Ebitda", key: "Ebitda" },
        { label: "Operating Income", key: "Operating Income" },
        { label: "Net Profit Margin", key: "Net Profit Margin" },
        { label: "Price-to-Sales Ratio", key: "Price to Sales Ratio" }
      ];

      // Helper to set active income period button style
      const setActiveIncomeButton = (activeBtnId) => {
        document.querySelectorAll('#incomeStatementContent .period-btn').forEach(button => {
          if (button.id === activeBtnId) {
            button.classList.remove('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
            button.classList.add('bg-indigo-700', 'text-white', 'hover:bg-indigo-800');
          } else {
            button.classList.remove('bg-indigo-700', 'text-white', 'hover:bg-indigo-800');
            button.classList.add('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
          }
        });
      };

      // Function to render income statement table and chart
      const renderIncomeContent = (period) => {
        currentIncomeStatementPeriod = period;
        let tableData, chartData;

        if (period === 'Yearly') {
          tableData = { ...data["Yearly Ratios"], ...data["Yearly Income Statement Info"] };
          chartData = data["Yearly Income Statement Info"]["Revenue"];
        } else { // Quarterly
          tableData = { ...data["Quarterly Ratios"], ...data["Quarterly Income Statement Info"] };
          chartData = data["Quarterly Income Statement Info"]["Revenue"];
        }
        
        renderTable('incomeTableContainer', tableData, period, incomeMetricsConfig);
        renderRevenueBarChart('revenueBarChart', chartData, period);
        setActiveIncomeButton(`incomeBtn${period}`);
      };

      // Add event listeners for income statement period buttons
      document.getElementById('incomeBtnYearly').addEventListener('click', () => renderIncomeContent('Yearly'));
      document.getElementById('incomeBtnQuarterly').addEventListener('click', () => renderIncomeContent('Quarterly'));

      // Initial render for income statement
      renderIncomeContent(currentIncomeStatementPeriod);

      // Handle window resize for bar chart responsiveness
      window.removeEventListener('resize', resizeIncomeChartHandler);
      window.addEventListener('resize', resizeIncomeChartHandler);
    }

    // Resize handler for income statement bar chart
    let resizeIncomeChartHandler = () => {
      if (activeTabId === 'incomeStatementContent' && allStockData && allStockData["Tab 2"]) {
        const data = allStockData["Tab 2"];
        let chartData;
        if (currentIncomeStatementPeriod === 'Yearly') {
            chartData = data["Yearly Income Statement Info"]["Revenue"];
        } else {
            chartData = data["Quarterly Income Statement Info"]["Revenue"];
        }
        renderRevenueBarChart('revenueBarChart', chartData, currentIncomeStatementPeriod);
      }
    };

    function renderRevenueBarChart(containerId, revenueData, period) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Clear previous chart

        if (!revenueData || revenueData === 'N/A' || revenueData.length === 0) {
            container.innerHTML = `<p class="text-gray-400 text-center">No Revenue data available for ${period} chart.</p>`;
            return;
        }

        // Parse and filter data for the last 4 periods
        const parsedData = revenueData.slice(0, 4).reverse().map((d, i) => { // Take last 4 and reverse for chronological order
            // Remove T, B, M, K and parse to number
            let value = parseFloat(d.replace(/[TBMK]/, ''));
            if (d.endsWith('T')) value *= 1_000_000_000_000;
            else if (d.endsWith('B')) value *= 1_000_000_000;
            else if (d.endsWith('M')) value *= 1_000_000;
            else if (d.endsWith('K')) value *= 1_000;
            return {
                value: value,
                label: period === 'Yearly' ? `Year ${4 - i}` : `Q${4 - i}` // Simple labels for now
            };
        }).filter(d => !isNaN(d.value));

        if (parsedData.length === 0) {
            container.innerHTML = `<p class="text-gray-400 text-center">No valid Revenue data to display for ${period} chart.</p>`;
            return;
        }

        const margin = { top: 20, right: 30, bottom: 40, left: 60 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = container.clientHeight - margin.top - margin.bottom;

        const svg = d3.select(`#${containerId}`)
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleBand()
            .range([0, width])
            .domain(parsedData.map(d => d.label))
            .padding(0.2);

        const y = d3.scaleLinear()
            .range([height, 0])
            .domain([0, d3.max(parsedData, d => d.value)]).nice();

        // Add X axis
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .attr("fill", "#9ca3af");

        // Add Y axis
        svg.append("g")
            .call(d3.axisLeft(y).ticks(5).tickFormat(d3.format(".2s"))) // Format Y-axis ticks
            .selectAll("text")
            .attr("fill", "#9ca3af");

        // Add bars
        svg.selectAll(".bar")
            .data(parsedData)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.label))
            .attr("y", d => y(d.value))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.value));
    }


    // --- Tab 3: Balance Sheet Info ---
    let currentBalanceSheetPeriod = 'Yearly'; // Default for Balance Sheet
    function renderBalanceSheetTab(data) {
      const contentDiv = document.getElementById('balanceSheetContent');
      contentDiv.innerHTML = ''; // Clear existing content

      if (!data || data === 'N/A' || data.error) {
        contentDiv.innerHTML = `<p class="text-red-400 text-center">No Balance Sheet data available for ${stock}.</p>`;
        return;
      }

      // Create structure for Balance Sheet tab
      contentDiv.innerHTML = `
        <div class="flex flex-wrap justify-center gap-2 w-full mb-4">
          <button id="balanceBtnYearly" class="period-btn bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
            Yearly
          </button>
          <button id="balanceBtnQuarterly" class="period-btn bg-gray-600 text-gray-200 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 transition duration-300 ease-in-out text-sm">
            Quarterly
          </button>
        </div>
        <div id="balanceTableContainer" class="w-full">
          <!-- Balance Sheet Table will be rendered here -->
        </div>
      `;

      // Define metrics for Balance Sheet table
      const balanceMetricsConfig = [
        { label: "Total Assets", key: "Total Assets" },
        { label: "Cash/Cash Equivalents", key: "Cash/Cash Equivalents" },
        { label: "Short Term Investments", key: "Short Term Investments" },
        { label: "Total Current Assets", key: "Total Current Assets" },
        { label: "Short Term Debt", key: "Short Term Debt" },
        { label: "Long Term Debt", key: "Long Term Debt" },
        { label: "Net Debt", key: "Net Debt" },
        { label: "Total Debt", key: "Total Debt" },
        { label: "Total Liabilities", key: "Total Liabilities" },
        { label: "Total Stockholders' Equity", key: "Total Stockholders' Equity" }
      ];

      // Helper to set active balance period button style
      const setActiveBalanceButton = (activeBtnId) => {
        document.querySelectorAll('#balanceSheetContent .period-btn').forEach(button => {
          if (button.id === activeBtnId) {
            button.classList.remove('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
            button.classList.add('bg-indigo-700', 'text-white', 'hover:bg-indigo-800');
          } else {
            button.classList.remove('bg-indigo-700', 'text-white', 'hover:bg-indigo-800');
            button.classList.add('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
          }
        });
      };

      // Function to render balance sheet table
      const renderBalanceContent = (period) => {
        currentBalanceSheetPeriod = period;
        let tableData;

        if (period === 'Yearly') {
          tableData = data["Yearly Balance Sheet Info"];
        } else { // Quarterly
          tableData = data["Quarterly Balance Sheet Info"];
        }
        
        renderTable('balanceTableContainer', tableData, period, balanceMetricsConfig);
        setActiveBalanceButton(`balanceBtn${period}`);
      };

      // Add event listeners for balance sheet period buttons
      document.getElementById('balanceBtnYearly').addEventListener('click', () => renderBalanceContent('Yearly'));
      document.getElementById('balanceBtnQuarterly').addEventListener('click', () => renderBalanceContent('Quarterly'));

      // Initial render for balance sheet
      renderBalanceContent(currentBalanceSheetPeriod);
    }

    // --- Tab 4: Rating ---
    function renderRatingTab(data) {
      const contentDiv = document.getElementById('ratingContent');
      contentDiv.innerHTML = ''; // Clear existing content

      if (!data || data === 'N/A' || data.error) {
        contentDiv.innerHTML = `<p class="text-red-400 text-center">No Rating data available for ${stock}.</p>`;
        return;
      }

      const getRatingColorClass = (rating) => {
        if (typeof rating !== 'string') return 'rating-NA';
        const firstChar = rating.charAt(0).toUpperCase();
        if (firstChar === 'A') return 'rating-A';
        if (firstChar === 'B') return 'rating-B';
        if (firstChar === 'C') return 'rating-C';
        if (firstChar === 'D' || firstChar === 'F') return 'rating-D';
        return 'rating-NA';
      };

      const ratingItems = [
        { label: "Valuation", value: data["Valuation"] },
        { label: "Stability", value: data["Stability"] },
        { label: "Profitability", value: data["Profitability"] },
        { label: "Growth", value: data["Growth"] },
        { label: "Overall Rating", value: data["Overall Rating"] },
        { label: "Consensus", value: data["Consensus"] }
      ];

      contentDiv.innerHTML = `
        <div class="bg-gray-700 rounded-lg p-6 shadow-lg w-full max-w-md mx-auto">
          <h3 class="text-2xl font-bold text-gray-100 mb-4 text-center">Analyst Ratings</h3>
          <div class="divide-y divide-gray-600">
            ${ratingItems.map(item => `
              <div class="flex justify-between items-center py-3">
                <strong class="text-gray-200 text-lg">${item.label}:</strong>
                <span class="text-xl font-semibold ${getRatingColorClass(item.value)}">${item.value || 'N/A'}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // --- Tab 5: Earnings Data ---
    function renderEarningsTab(data) {
      const contentDiv = document.getElementById('earningsContent');
      contentDiv.innerHTML = ''; // Clear existing content

      if (!data || data === 'N/A' || data.error) {
        contentDiv.innerHTML = `<p class="text-red-400 text-center">No Earnings data available for ${stock}.</p>`;
        return;
      }

      const pastEarnings = data["Past 4 Quarters' Earnings"] || [];
      const nextQuarter = data["Next Quarter Estimates"] || {};

      contentDiv.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
          <!-- Past Earnings Box -->
          <div class="past-earnings-box bg-gray-700 rounded-lg p-6 shadow-lg flex flex-col">
            <h3 class="text-2xl font-bold text-gray-100 mb-4 text-center">Past 4 Quarters' Earnings</h3>
            ${pastEarnings.length > 0 ? `
              <div class="divide-y divide-gray-600">
                ${pastEarnings.map(earning => `
                  <div class="py-3">
                    <p><strong class="text-gray-200">Date:</strong> <span class="text-gray-300">${earning.Date || 'N/A'}</span></p>
                    <p><strong class="text-gray-200">EPS Estimate:</strong> <span class="text-gray-300">${earning["EPS Estimate"] || 'N/A'}</span></p>
                    <p><strong class="text-gray-200">EPS Result:</strong> <span class="text-gray-300">${earning["EPS Result"] || 'N/A'}</span></p>
                    <p><strong class="text-gray-200">EPS Surprise:</strong> <span class="text-gray-300">${earning["EPS Surprise (%)"] !== undefined ? earning["EPS Surprise (%)"] + '%' : 'N/A'}</span></p>
                    <p><strong class="text-gray-200">Revenue Estimate:</strong> <span class="text-gray-300">${earning["Revenue Estimate"] || 'N/A'}</span></p>
                    <p><strong class="text-gray-200">Revenue Result:</strong> <span class="text-gray-300">${earning["Revenue Result"] || 'N/A'}</span></p>
                    <p><strong class="text-gray-200">Revenue Surprise:</strong> <span class="text-gray-300">${earning["Revenue Surprise (%)"] !== undefined ? earning["Revenue Surprise (%)"] + '%' : 'N/A'}</span></p>
                  </div>
                `).join('')}
              </div>
            ` : `<p class="text-gray-400 text-center">No past earnings data available.</p>`}
          </div>

          <!-- Next Quarter Estimates Box -->
          <div class="next-quarter-box bg-gray-700 rounded-lg p-6 shadow-lg flex flex-col">
            <h3 class="text-2xl font-bold text-gray-100 mb-4 text-center">Next Quarter Expectations</h3>
            ${nextQuarter && Object.keys(nextQuarter).length > 0 ? `
              <div class="divide-y divide-gray-600">
                <div class="py-3">
                  <p><strong class="text-gray-200">Date:</strong> <span class="text-gray-300">${nextQuarter.Date || 'N/A'}</span></p>
                  <p><strong class="text-gray-200">EPS Estimate:</strong> <span class="text-gray-300">${nextQuarter["EPS Estimate"] || 'N/A'}</span></p>
                  <p><strong class="text-gray-200">Revenue Estimate:</strong> <span class="text-gray-300">${nextQuarter["Revenue Estimate"] || 'N/A'}</span></p>
                </div>
              </div>
            ` : `<p class="text-gray-400 text-center">No next quarter estimates available.</p>`}
          </div>
        </div>
      `;
    }

    // --- Tab 6: Latest Insider Trades ---
    function renderInsiderTradesTab(data) {
      const contentDiv = document.getElementById('insiderTradesContent');
      contentDiv.innerHTML = ''; // Clear existing content

      if (!data || data === 'N/A' || data.error || data.length === 0) {
        contentDiv.innerHTML = `<p class="text-red-400 text-center">No Insider Trades data available for ${stock}.</p>`;
        return;
      }

      contentDiv.innerHTML = `
        <div class="bg-gray-700 rounded-lg p-6 shadow-lg w-full overflow-x-auto">
          <h3 class="text-2xl font-bold text-gray-100 mb-4 text-center">Latest Insider Trades</h3>
          <div class="data-table-container">
            <table class="min-w-full divide-y divide-gray-600">
              <thead>
                <tr class="bg-gray-600">
                  <th class="py-3 px-4 text-left text-sm font-medium text-gray-200 uppercase tracking-wider sticky-col-header">Date</th>
                  <th class="py-3 px-4 text-left text-sm font-medium text-gray-200 uppercase tracking-wider">Reporter</th>
                  <th class="py-3 px-4 text-left text-sm font-medium text-gray-200 uppercase tracking-wider">Role</th>
                  <th class="py-3 px-4 text-right text-sm font-medium text-gray-200 uppercase tracking-wider">Shares</th>
                  <th class="py-3 px-4 text-left text-sm font-medium text-gray-200 uppercase tracking-wider">Type</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                ${data.map(trade => `
                  <tr class="bg-gray-800 hover:bg-gray-700 transition-colors duration-200">
                    <td class="py-3 px-4 text-sm text-gray-300 whitespace-nowrap sticky-row-header">${trade.Date || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm text-gray-300 whitespace-nowrap">${trade.Reporter || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm text-gray-300 whitespace-nowrap">${trade.Role || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm text-gray-300 whitespace-nowrap text-right">${trade.Shares !== undefined ? trade.Shares.toLocaleString() : 'N/A'}</td>
                    <td class="py-3 px-4 text-sm text-gray-300 whitespace-nowrap">${trade["Transaction Type"] || 'N/A'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // --- Tab 7: Analyst Price Targets ---
    function renderPriceTargetsTab(data) {
      const contentDiv = document.getElementById('priceTargetsContent');
      contentDiv.innerHTML = ''; // Clear existing content

      if (!data || data === 'N/A' || data.error || Object.keys(data).length === 0) {
        contentDiv.innerHTML = `<p class="text-red-400 text-center">No Price Targets data available for ${stock}.</p>`;
        return;
      }

      contentDiv.innerHTML = `
        <div class="bg-gray-700 rounded-lg p-6 shadow-lg w-full max-w-md mx-auto">
          <h3 class="text-2xl font-bold text-gray-100 mb-4 text-center">Analyst Price Targets</h3>
          <div class="divide-y divide-gray-600">
            <div class="flex justify-between items-center py-3">
              <strong class="text-gray-200 text-lg">Target High:</strong>
              <span class="text-gray-300 text-xl">${data["Target High"] || 'N/A'}</span>
            </div>
            <div class="flex justify-between items-center py-3">
              <strong class="text-gray-200 text-lg">Target Low:</strong>
              <span class="text-gray-300 text-xl">${data["Target Low"] || 'N/A'}</span>
            </div>
            <div class="flex justify-between items-center py-3">
              <strong class="text-gray-200 text-lg">Target Consensus:</strong>
              <span class="text-gray-300 text-xl">${data["Target Consensus"] || 'N/A'}</span>
            </div>
          </div>
        </div>
      `;
    }

    // Main function to fetch all data
    async function fetchAndRenderAllData() {
      if (!stock) {
        stockNameHeader.textContent = "Error";
        stockSymbolHeader.textContent = "No stock symbol provided.";
        return;
      }

      stockNameHeader.textContent = `${stock} - Loading...`;
      stockSymbolHeader.textContent = "Fetching all data...";

      try {
        const response = await fetch(`https://stock-backend-0128.onrender.com/all_data?stock=${stock}`); 
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Backend error (${response.status}): ${errorText.substring(0, 200)}`);
        }
        
        allStockData = await response.json();
        console.log("All Stock Data Fetched:", allStockData); // Debug log

        // Update header with actual company name and symbol if available
        // Note: Your backend provides "Profile Info" under "Tab 1"
        if (allStockData["Tab 1"] && allStockData["Tab 1"]["Profile Info"] && allStockData["Tab 1"]["Profile Info"]["Company Name"]) {
          stockNameHeader.textContent = allStockData["Tab 1"]["Profile Info"]["Company Name"];
          // Using 'Sector' from Profile Info as 'exchange' for display purposes, as direct 'exchange' wasn't in JSON
          stockSymbolHeader.textContent = `(${allStockData["Tab 1"]["Profile Info"]["Sector"] || 'N/A'}: ${stock})`; 
        } else {
          stockNameHeader.textContent = `${stock} - Data Loaded`;
          stockSymbolHeader.textContent = `(Symbol: ${stock})`;
        }

        // Render the initial active tab content
        renderActiveTabContent();

      } catch (error) {
        stockNameHeader.textContent = "Error Loading Data";
        stockSymbolHeader.textContent = `For ${stock}: ${error.message}`;
        console.error("Error fetching all stock data:", error);
        // Display error message in all tab content areas
        tabContents.forEach(content => {
          content.innerHTML = `<p class="text-red-400 text-center">Error loading data: ${error.message}</p>`;
        });
      }
    }

    // Function to navigate back to the index page
    function goback() {
      window.location.href = 'index.html';
    }

    // Initial fetch when the page loads
    fetchAndRenderAllData();
  </script>
</body>
</html>
